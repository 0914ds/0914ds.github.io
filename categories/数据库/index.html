<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Category: 数据库 - blog</title><link rel="manifest" href="../../manifest.json"><meta name="application-name" content="blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="blog"><meta property="og:url" content="https://0914ds.github.io/"><meta property="og:site_name" content="blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://0914ds.github.io/img/og_image.png"><meta property="article:author" content="albert dong"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://0914ds.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://0914ds.github.io"},"headline":"blog","image":["https://0914ds.github.io/img/og_image.png"],"author":{"@type":"Person","name":"albert dong"},"publisher":{"@type":"Organization","name":"blog","logo":{"@type":"ImageObject","url":"https://0914ds.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="../../img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="../../css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="atom.xml" title="blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="../../index.html"><img src="../../img/logo.svg" alt="blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="../../index.html">Home</a><a class="navbar-item" href="../../archives">Archives</a><a class="navbar-item" href="../../categories">Categories</a><a class="navbar-item" href="../../tags">Tags</a><a class="navbar-item" href="../../about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="../../categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">数据库</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-06-05T07:02:29.235Z" title="2023/6/5 15:02:29">2023-06-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-06-22T07:12:23.552Z" title="2023/6/22 15:12:23">2023-06-22</time></span><span class="level-item"><a class="link-muted" href="">数据库</a></span><span class="level-item">25 minutes read (About 3803 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="../../2023/06/05/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql%E7%9A%84%E9%94%81%E6%9C%BA%E5%88%B6/">mysql的锁机制</a></p><div class="content"><h1 id="mysql的锁机制">mysql的锁机制</h1>
<h3 id="mysql锁的基本介绍">1、MySQL锁的基本介绍</h3>
<p>​
<strong>锁是计算机协调多个进程或线程并发访问某一资源的机制。</strong>在数据库中，除传统的
计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一
个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<p>​ 相对其他数据库而言，MySQL的锁机制比较简单，其最
显著的特点是不同的<strong>存储引擎</strong>支持不同的锁机制。比如，MyISAM和MEMORY存储引擎采用的是表级锁（table-level
locking）；InnoDB存储引擎既支持行级锁（row-level
locking），也支持表级锁，但默认情况下是采用行级锁。</p>
<p>​
<strong>表级锁：</strong>开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。
​
<strong>行级锁：</strong>开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</p>
<p>​
从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适！仅从锁的角度
来说：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如Web应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有
并发查询的应用，如一些在线事务处理（OLTP）系统。</p>
<h3 id="myisam表锁">2、MyISAM表锁</h3>
<p>MySQL的表级锁有两种模式：<strong>表共享读锁（Table Read
Lock）</strong>和<strong>表独占写锁（Table Write Lock）</strong>。</p>
<p>对MyISAM表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求；对
MyISAM表的写操作，则会阻塞其他用户对同一表的读和写操作；MyISAM表的读操作与写操作之间，以及写操作之间是串行的！</p>
<p>建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `mylock` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `NAME` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>MyISAM <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `mylock` (`id`, `NAME`) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `mylock` (`id`, `NAME`) <span class="keyword">VALUES</span> (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `mylock` (`id`, `NAME`) <span class="keyword">VALUES</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `mylock` (`id`, `NAME`) <span class="keyword">VALUES</span> (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;d&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>MyISAM写锁阻塞读的案例：</strong></p>
<p>​
当一个线程获得对一个表的写锁之后，只有持有锁的线程可以对表进行更新操作。其他线程的读写操作都会等待，直到锁释放为止。</p>
<table>
<colgroup>
<col style="width: 66%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">session1</th>
<th style="text-align: center;">session2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">获取表的write锁定<br>lock table mylock
write;</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">当前session对表的查询，插入，更新操作都可以执行<br>select
* from mylock;<br>insert into mylock values(5,'e');</td>
<td style="text-align: center;">当前session对表的查询会被阻塞<br>select *
from mylock；</td>
</tr>
<tr class="odd">
<td style="text-align: center;">释放锁：<br>unlock tables；</td>
<td style="text-align: center;">当前session能够立刻执行，并返回对应结果</td>
</tr>
</tbody>
</table>
<p><strong>MyISAM读阻塞写的案例：</strong></p>
<p>​ 一个session使用lock
table给表加读锁，这个session可以锁定表中的记录，但更新和访问其他表都会提示错误，同时，另一个session可以查询表中的记录，但更新就会出现锁等待。</p>
<table>
<colgroup>
<col style="width: 71%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">session1</th>
<th style="text-align: center;">session2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">获得表的read锁定<br>lock table mylock
read;</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">当前session可以查询该表记录：<br>select *
from mylock;</td>
<td style="text-align: center;">当前session可以查询该表记录：<br>select *
from mylock;</td>
</tr>
<tr class="odd">
<td style="text-align: center;">当前session不能查询没有锁定的表<br>select
* from person<br>Table 'person' was not locked with LOCK TABLES</td>
<td style="text-align: center;">当前session可以查询或者更新未锁定的表<br>select
* from mylock<br>insert into person values(1,'zhangsan');</td>
</tr>
<tr class="even">
<td style="text-align: center;">当前session插入或者更新表会提示错误<br>insert
into mylock values(6,'f')<br>Table 'mylock' was locked with a READ
lock and can't be updated<br>update mylock set name='aa' where id =
1;<br>Table 'mylock' was locked with a READ lock and can't be
updated</td>
<td style="text-align: center;">当前session插入数据会等待获得锁<br>insert
into mylock values(6,'f');</td>
</tr>
<tr class="odd">
<td style="text-align: center;">释放锁<br>unlock tables;</td>
<td style="text-align: center;">获得锁，更新成功</td>
</tr>
</tbody>
</table>
<h3 id="注意">注意:</h3>
<p><strong>MyISAM在执行查询语句之前，会自动给涉及的所有表加读锁，在执行更新操作前，会自动给涉及的表加写锁，这个过程并不需要用户干预，因此用户一般不需要使用命令来显式加锁，上例中的加锁时为了演示效果。</strong></p>
<p><strong>MyISAM的并发插入问题</strong></p>
<p>MyISAM表的读和写是串行的，这是就总体而言的，在一定条件下，MyISAM也支持查询和插入操作的并发执行</p>
<table>
<colgroup>
<col style="width: 76%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">session1</th>
<th style="text-align: center;">session2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">获取表的read local锁定<br>lock table
mylock read local</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">当前session不能对表进行更新或者插入操作<br>insert
into mylock values(6,'f')<br>Table 'mylock' was locked with a READ
lock and can't be updated<br>update mylock set name='aa' where id =
1;<br>Table 'mylock' was locked with a READ lock and can't be
updated</td>
<td style="text-align: center;">其他session可以查询该表的记录<br>select*
from mylock</td>
</tr>
<tr class="odd">
<td style="text-align: center;">当前session不能查询没有锁定的表<br>select
* from person<br>Table 'person' was not locked with LOCK TABLES</td>
<td style="text-align: center;">其他session可以进行插入操作，但是更新会阻塞<br>update
mylock set name = 'aa' where id = 1;</td>
</tr>
<tr class="even">
<td style="text-align: center;">当前session不能访问其他session插入的记录；</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">释放锁资源：unlock tables</td>
<td style="text-align: center;">当前session获取锁，更新操作完成</td>
</tr>
<tr class="even">
<td style="text-align: center;">当前session可以查看其他session插入的记录</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定争夺：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;table%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name         <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Table_locks_immediate <span class="operator">|</span> <span class="number">352</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Table_locks_waited    <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="comment">--如果Table_locks_waited的值比较高，则说明存在着较严重的表级锁争用情况。</span></span><br></pre></td></tr></table></figure>
<p><strong>InnoDB锁</strong></p>
<p><strong>1、事务及其ACID属性</strong></p>
<p>事务是由一组SQL语句组成的逻辑处理单元，事务具有4属性，通常称为事务的ACID属性。</p>
<p>原子性（Actomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。
一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。
隔离性（Isolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。
持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</p>
<p><strong>2、并发事务带来的问题</strong></p>
<p>相对于串行处理来说，并发事务处理能大大增加数据库资源的利用率，提高数据库系统的事务吞吐量，从而可以支持更多用户的并发操作，但与此同时，会带来一下问题：</p>
<p><strong>脏读</strong>：
一个事务正在对一条记录做修改，在这个事务并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”的数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做“脏读”</p>
<p><strong>不可重复读</strong>：一个事务在读取某些数据已经发生了改变、或某些记录已经被删除了！这种现象叫做“不可重复读”。</p>
<p><strong>幻读</strong>：
一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读”</p>
<p>上述出现的问题都是数据库读一致性的问题，可以通过事务的隔离机制来进行保证。</p>
<p>数据库的事务隔离越严格，并发副作用就越小，但付出的代价也就越大，因为事务隔离本质上就是使事务在一定程度上串行化，需要根据具体的业务需求来决定使用哪种隔离级别</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">脏读</th>
<th style="text-align: center;">不可重复读</th>
<th style="text-align: center;">幻读</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">read uncommitted</td>
<td style="text-align: center;">√</td>
<td style="text-align: center;">√</td>
<td style="text-align: center;">√</td>
</tr>
<tr class="even">
<td style="text-align: center;">read committed</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">√</td>
<td style="text-align: center;">√</td>
</tr>
<tr class="odd">
<td style="text-align: center;">repeatable read</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">√</td>
</tr>
<tr class="even">
<td style="text-align: center;">serializable</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p>可以通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;innodb_row_lock%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_current_waits <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time          <span class="operator">|</span> <span class="number">18702</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_avg      <span class="operator">|</span> <span class="number">18702</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_max      <span class="operator">|</span> <span class="number">18702</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_waits         <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="comment">--如果发现锁争用比较严重，如InnoDB_row_lock_waits和InnoDB_row_lock_time_avg的值比较高</span></span><br></pre></td></tr></table></figure>
<p><strong>3、InnoDB的行锁模式及加锁方法</strong></p>
<p>​
<strong>共享锁（s）</strong>：又称读锁。允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。若事务T对数据对象A加上S锁，则事务T可以读A但不能修改A，其他事务只能再对A加S锁，而不能加X锁，直到T释放A上的S锁。这保证了其他事务可以读A，但在T释放A上的S锁之前不能对A做任何修改。
​
<strong>排他锁（x）</strong>：又称写锁。允许获取排他锁的事务更新数据，阻止其他事务取得相同的数据集共享读锁和排他写锁。若事务T对数据对象A加上X锁，事务T可以读A也可以修改A，其他事务不能再对A加任何锁，直到T释放A上的锁。</p>
<p>​ mysql
InnoDB引擎默认的修改数据语句：<strong>update,delete,insert都会自动给涉及到的数据加上排他锁，select语句默认不会加任何锁类型</strong>，如果加排他锁可以使用select
…for update语句，加共享锁可以使用select … lock in share
mode语句。<strong>所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过for
update和lock in share mode锁的方式查询数据，但可以直接通过select
…from…查询数据，因为普通查询没有任何锁机制。</strong></p>
<p><strong>InnoDB行锁实现方式</strong></p>
<p>​
InnoDB行锁是通过给<strong>索引</strong>上的索引项加锁来实现的，这一点MySQL与Oracle不同，后者是通过在数据块中对相应数据行加锁来实现的。InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，InnoDB才使用行级锁，<strong>否则，InnoDB将使用表锁！</strong></p>
<p>1、在不通过索引条件查询的时候，innodb使用的是表锁而不是行锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tab_no_index(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>)) engine<span class="operator">=</span>innodb;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab_no_index <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;2&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;4&#x27;</span>);</span><br></pre></td></tr></table></figure>
<table>
<colgroup>
<col style="width: 50%">
<col style="width: 49%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">session1</th>
<th style="text-align: center;">session2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">set autocommit=0<br>select * from
tab_no_index where id = 1;</td>
<td style="text-align: center;">set autocommit=0<br>select * from
tab_no_index where id =2</td>
</tr>
<tr class="even">
<td style="text-align: center;">select * from tab_no_index where id = 1
for update</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;">select * from tab_no_index where id = 2
for update;</td>
</tr>
</tbody>
</table>
<p>session1只给一行加了排他锁，但是session2在请求其他行的排他锁的时候，会出现锁等待。原因是在没有索引的情况下，innodb只能使用表锁。</p>
<p>2、创建带索引的表进行条件查询，innodb使用的是行锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tab_with_index(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>)) engine<span class="operator">=</span>innodb;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> tab_with_index <span class="keyword">add</span> index id(id);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab_with_index <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;2&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;4&#x27;</span>);</span><br></pre></td></tr></table></figure>
<table>
<colgroup>
<col style="width: 50%">
<col style="width: 49%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">session1</th>
<th style="text-align: center;">session2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">set autocommit=0<br>select * from
tab_with_indexwhere id = 1;</td>
<td style="text-align: center;">set autocommit=0<br>select * from
tab_with_indexwhere id =2</td>
</tr>
<tr class="even">
<td style="text-align: center;">select * from tab_with_indexwhere id = 1
for update</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;">select * from tab_with_indexwhere id = 2
for update;</td>
</tr>
</tbody>
</table>
<p>3、由于mysql的行锁是针对索引加的锁，不是针对记录加的锁，所以虽然是访问不同行的记录，但是依然无法访问到具体的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tab_with_index  <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;4&#x27;</span>);</span><br></pre></td></tr></table></figure>
<table>
<colgroup>
<col style="width: 35%">
<col style="width: 64%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">session1</th>
<th style="text-align: center;">session2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">set autocommit=0</td>
<td style="text-align: center;">set autocommit=0</td>
</tr>
<tr class="even">
<td style="text-align: center;">select * from tab_with_index where id =
1 and name='1' for update</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: center;">select * from tab_with_index where id =
1 and name='4' for
update<br>虽然session2访问的是和session1不同的记录，但是因为使用了相同的索引，所以需要等待锁</td>
</tr>
</tbody>
</table>
<h3 id="总结">总结</h3>
<p><strong>对于MyISAM的表锁，主要讨论了以下几点：</strong>
（1）共享读锁（S）之间是兼容的，但共享读锁（S）与排他写锁（X）之间，以及排他写锁（X）之间是互斥的，也就是说读和写是串行的。<br>
（2）在一定条件下，MyISAM允许查询和插入并发执行，我们可以利用这一点来解决应用中对同一表查询和插入的锁争用问题。
（3）MyISAM默认的锁调度机制是写优先，这并不一定适合所有应用，用户可以通过设置LOW_PRIORITY_UPDATES参数，或在INSERT、UPDATE、DELETE语句中指定LOW_PRIORITY选项来调节读写锁的争用。
（4）由于表锁的锁定粒度大，读写之间又是串行的，因此，如果更新操作较多，MyISAM表可能会出现严重的锁等待，可以考虑采用InnoDB表来减少锁冲突。</p>
<p><strong>对于InnoDB表，本文主要讨论了以下几项内容：</strong>
（1）InnoDB的行锁是基于索引实现的，如果不通过索引访问数据，InnoDB会使用表锁。
（2）在不同的隔离级别下，InnoDB的锁机制和一致性读策略不同。</p>
<p>在了解InnoDB锁特性后，用户可以通过设计和SQL调整等措施减少锁冲突和死锁，包括：</p>
<ul>
<li>尽量使用较低的隔离级别；
精心设计索引，并尽量使用索引访问数据，使加锁更精确，从而减少锁冲突的机会；</li>
<li>选择合理的事务大小，小事务发生锁冲突的几率也更小；</li>
<li>给记录集显式加锁时，最好一次性请求足够级别的锁。比如要修改数据的话，最好直接申请排他锁，而不是先申请共享锁，修改时再请求排他锁，这样容易产生死锁；</li>
<li>不同的程序访问一组表时，应尽量约定以相同的顺序访问各表，对一个表而言，尽可能以固定的顺序存取表中的行。这样可以大大减少死锁的机会；</li>
<li>尽量用相等条件访问数据，这样可以避免间隙锁对并发插入的影响；
不要申请超过实际需要的锁级别；除非必须，查询时不要显示加锁；</li>
<li>对于一些特定的事务，可以使用表锁来提高处理速度或减少死锁的可能。</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-06-04T05:13:16.000Z" title="2023/6/4 13:13:16">2023-06-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-06-22T07:12:12.061Z" title="2023/6/22 15:12:12">2023-06-22</time></span><span class="level-item"><a class="link-muted" href="">数据库</a></span><span class="level-item">40 minutes read (About 5988 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="../../2023/06/04/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MYSQL%20performance%20schema%E8%AF%A6%E8%A7%A3/">MYSQL performance schema详解</a></p><div class="content"><h1 id="mysql-performance-schema详解">MYSQL performance schema详解</h1>
<h3 id="performance_schema的介绍">0、performance_schema的介绍</h3>
<p>​ <strong>MySQL的performance schema 用于监控MySQL
server在一个较低级别的运行过程中的资源消耗、资源等待等情况</strong>。</p>
<p>​ 特点如下：</p>
<p>​
1、提供了一种在数据库运行时实时检查server的内部执行情况的方法。performance_schema
数据库中的表使用performance_schema存储引擎。该数据库主要关注数据库运行过程中的性能相关的数据，与information_schema不同，information_schema主要关注server运行过程中的元数据信息</p>
<p>​
2、performance_schema通过监视server的事件来实现监视server内部运行情况，
“事件”就是server内部活动中所做的任何事情以及对应的时间消耗，利用这些信息来判断server中的相关资源消耗在了哪里？一般来说，事件可以是函数调用、操作系统的等待、SQL语句执行的阶段（如sql语句执行过程中的parsing
或
sorting阶段）或者整个SQL语句与SQL语句集合。事件的采集可以方便的提供server中的相关存储引擎对磁盘文件、表I/O、表锁等资源的同步调用信息。
​
3、performance_schema中的事件与写入二进制日志中的事件（描述数据修改的events）、事件计划调度程序（这是一种存储程序）的事件不同。performance_schema中的事件记录的是server执行某些活动对某些资源的消耗、耗时、这些活动执行的次数等情况。
​
4、performance_schema中的事件只记录在本地server的performance_schema中，其下的这些表中数据发生变化时不会被写入binlog中，也不会通过复制机制被复制到其他server中。
​5、
当前活跃事件、历史事件和事件摘要相关的表中记录的信息。能提供某个事件的执行次数、使用时长。进而可用于分析某个特定线程、特定对象（如mutex或file）相关联的活动。
​
6、PERFORMANCE_SCHEMA存储引擎使用server源代码中的“检测点”来实现事件数据的收集。对于performance_schema实现机制本身的代码没有相关的单独线程来检测，这与其他功能（如复制或事件计划程序）不同
​
7、收集的事件数据存储在performance_schema数据库的表中。这些表可以使用SELECT语句查询，也可以使用SQL语句更新performance_schema数据库中的表记录（如动态修改performance_schema的setup_*开头的几个配置表，但要注意：配置表的更改会立即生效，这会影响数据收集）
​
8、performance_schema的表中的数据不会持久化存储在磁盘中，而是保存在内存中，一旦服务器重启，这些数据会丢失（包括配置表在内的整个performance_schema下的所有数据）
​
9、MySQL支持的所有平台中事件监控功能都可用，但不同平台中用于统计事件时间开销的计时器类型可能会有所差异。</p>
<h3 id="performance-schema入门">1、performance schema入门</h3>
<p>​
在mysql的5.7版本中，性能模式是默认开启的，如果想要显式的关闭的话需要修改配置文件，不能直接进行修改，会报错Variable
'performance_schema' is a read only variable。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看performance_schema的属性</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;performance_schema&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name      <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--在配置文件中修改performance_schema的属性值，on表示开启，off表示关闭</span></span><br><span class="line">[mysqld]</span><br><span class="line">performance_schema<span class="operator">=</span><span class="keyword">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--切换数据库</span></span><br><span class="line">use performance_schema;</span><br><span class="line"></span><br><span class="line"><span class="comment">--查看当前数据库下的所有表,会看到有很多表存储着相关的信息</span></span><br><span class="line"><span class="keyword">show</span> tables;</span><br><span class="line"></span><br><span class="line"><span class="comment">--可以通过show create table tablename来查看创建表的时候的表结构</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> setup_consumers;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+---------------------------------</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span>           <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                    </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+---------------------------------</span></span><br><span class="line"><span class="operator">|</span> setup_consumers <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `setup_consumers` (</span><br><span class="line">  `NAME` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,                      </span><br><span class="line">  `ENABLED` enum(<span class="string">&#x27;YES&#x27;</span>,<span class="string">&#x27;NO&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>               </span><br><span class="line">) ENGINE<span class="operator">=</span>PERFORMANCE_SCHEMA <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+---------------------------------</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)                             </span><br></pre></td></tr></table></figure>
<p>​ 想要搞明白后续的内容，同学们需要理解两个基本概念：</p>
<p>​ instruments:
生产者，用于采集mysql中各种各样的操作产生的事件信息，对应配置表中的配置项我们可以称为监控采集配置项。</p>
<p>​
consumers:消费者，对应的消费者表用于存储来自instruments采集的数据，对应配置表中的配置项我们可以称为消费存储配置项。</p>
<h3 id="performance_schema表的分类">2、performance_schema表的分类</h3>
<p>​ performance_schema库下的表可以按照监视不同的纬度就行分组。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--语句事件记录表，这些表记录了语句事件信息，当前语句事件表events_statements_current、历史语句事件表events_statements_history和长语句历史事件表events_statements_history_long、以及聚合后的摘要表summary，其中，summary表还可以根据帐号(account)，主机(host)，程序(program)，线程(thread)，用户(user)和全局(global)再进行细分)</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%statement%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--等待事件记录表，与语句事件类型的相关记录表类似：</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%wait%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--阶段事件记录表，记录语句执行的阶段事件的表</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%stage%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--事务事件记录表，记录事务相关的事件的表</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%transaction%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--监控文件系统层调用的表</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%file%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--监视内存使用的表</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%memory%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--动态对performance_schema进行配置的配置表</span></span><br><span class="line"><span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;%setup%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="performance_schema的简单配置与使用">3、performance_schema的简单配置与使用</h3>
<p>​
数据库刚刚初始化并启动时，并非所有instruments(事件采集项，在采集项的配置表中每一项都有一个开关字段，或为YES，或为NO)和consumers(与采集项类似，也有一个对应的事件类型保存表配置项，为YES就表示对应的表保存性能数据，为NO就表示对应的表不保存性能数据)都启用了，所以默认不会收集所有的事件，可能你需要检测的事件并没有打开，需要进行设置，可以使用如下两个语句打开对应的instruments和consumers（行计数可能会因MySQL版本而异)。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--打开等待事件的采集器配置项开关，需要修改setup_instruments配置表中对应的采集器配置项</span></span><br><span class="line"><span class="keyword">UPDATE</span> setup_instruments <span class="keyword">SET</span> ENABLED <span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span>, TIMED <span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span><span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;wait%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--打开等待事件的保存表配置开关，修改setup_consumers配置表中对应的配置项</span></span><br><span class="line"><span class="keyword">UPDATE</span> setup_consumers <span class="keyword">SET</span> ENABLED <span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span><span class="keyword">where</span> name <span class="keyword">like</span> <span class="string">&#x27;%wait%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--当配置完成之后可以查看当前server正在做什么，可以通过查询events_waits_current表来得知，该表中每个线程只包含一行数据，用于显示每个线程的最新监视事件</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> events_waits_current\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">            THREAD_ID: <span class="number">11</span></span><br><span class="line">             EVENT_ID: <span class="number">570</span></span><br><span class="line">         END_EVENT_ID: <span class="number">570</span></span><br><span class="line">           EVENT_NAME: wait<span class="operator">/</span>synch<span class="operator">/</span>mutex<span class="operator">/</span>innodb<span class="operator">/</span>buf_dblwr_mutex</span><br><span class="line">               SOURCE: </span><br><span class="line">          TIMER_START: <span class="number">4508505105239280</span></span><br><span class="line">            TIMER_END: <span class="number">4508505105270160</span></span><br><span class="line">           TIMER_WAIT: <span class="number">30880</span></span><br><span class="line">                SPINS: <span class="keyword">NULL</span></span><br><span class="line">        OBJECT_SCHEMA: <span class="keyword">NULL</span></span><br><span class="line">          OBJECT_NAME: <span class="keyword">NULL</span></span><br><span class="line">           INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">          OBJECT_TYPE: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">67918392</span></span><br><span class="line">     NESTING_EVENT_ID: <span class="keyword">NULL</span></span><br><span class="line">   NESTING_EVENT_TYPE: <span class="keyword">NULL</span></span><br><span class="line">            OPERATION: lock</span><br><span class="line">      NUMBER_OF_BYTES: <span class="keyword">NULL</span></span><br><span class="line">                FLAGS: <span class="keyword">NULL</span></span><br><span class="line"><span class="comment">/*该信息表示线程id为11的线程正在等待buf_dblwr_mutex锁，等待事件为30880</span></span><br><span class="line"><span class="comment">属性说明：</span></span><br><span class="line"><span class="comment">    id:事件来自哪个线程，事件编号是多少</span></span><br><span class="line"><span class="comment">    event_name:表示检测到的具体的内容</span></span><br><span class="line"><span class="comment">    source:表示这个检测代码在哪个源文件中以及行号</span></span><br><span class="line"><span class="comment">    timer_start:表示该事件的开始时间</span></span><br><span class="line"><span class="comment">    timer_end:表示该事件的结束时间</span></span><br><span class="line"><span class="comment">    timer_wait:表示该事件总的花费时间</span></span><br><span class="line"><span class="comment">注意：_current表中每个线程只保留一条记录，一旦线程完成工作，该表中不会再记录该线程的事件信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">_history表中记录每个线程应该执行完成的事件信息，但每个线程的事件信息只会记录10条，再多就会被覆盖，*_history_long表中记录所有线程的事件信息，但总记录数量是10000，超过就会被覆盖掉</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">select</span> thread_id,event_id,event_name,timer_wait <span class="keyword">from</span> events_waits_history <span class="keyword">order</span> <span class="keyword">by</span> thread_id limit <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">summary表提供所有事件的汇总信息，该组中的表以不同的方式汇总事件数据（如：按用户，按主机，按线程等等）。例如：要查看哪些instruments占用最多的时间，可以通过对events_waits_summary_global_by_event_name表的COUNT_STAR或SUM_TIMER_WAIT列进行查询（这两列是对事件的记录数执行COUNT（*）、事件记录的TIMER_WAIT列执行SUM（TIMER_WAIT）统计而来）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_NAME,COUNT_STAR <span class="keyword">FROM</span> events_waits_summary_global_by_event_name  <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span> LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">instance表记录了哪些类型的对象会被检测。这些对象在被server使用时，在该表中将会产生一条事件记录，例如，file_instances表列出了文件I/O操作及其关联文件名</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> file_instances limit <span class="number">20</span>; </span><br></pre></td></tr></table></figure>
<h3 id="常用配置项的参数说明">4、常用配置项的参数说明</h3>
<p>1、启动选项</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_consumer_events_statements_current<span class="operator">=</span><span class="literal">TRUE</span></span><br><span class="line">是否在mysql server启动时就开启events_statements_current表的记录功能(该表记录当前的语句事件信息)，启动之后也可以在setup_consumers表中使用<span class="keyword">UPDATE</span>语句进行动态更新setup_consumers配置表中的events_statements_current配置项，默认值为<span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">performance_schema_consumer_events_statements_history<span class="operator">=</span><span class="literal">TRUE</span></span><br><span class="line">与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件短历史信息，默认为<span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">performance_schema_consumer_events_stages_history_long<span class="operator">=</span><span class="literal">FALSE</span></span><br><span class="line">与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件长历史信息，默认为<span class="literal">FALSE</span></span><br><span class="line"></span><br><span class="line">除了statement(语句)事件之外，还支持：wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个启动项分别进行配置，但这些等待事件默认未启用，如果需要在MySQL Server启动时一同启动，则通常需要写进my.cnf配置文件中</span><br><span class="line">performance_schema_consumer_global_instrumentation<span class="operator">=</span><span class="literal">TRUE</span></span><br><span class="line">是否在MySQL Server启动时就开启全局表（如：mutex_instances、rwlock_instances、cond_instances、file_instances、users、hostsaccounts、socket_summary_by_event_name、file_summary_by_instance等大部分的全局对象计数统计和事件汇总统计信息表 ）的记录功能，启动之后也可以在setup_consumers表中使用<span class="keyword">UPDATE</span>语句进行动态更新全局配置项</span><br><span class="line">默认值为<span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">performance_schema_consumer_statements_digest<span class="operator">=</span><span class="literal">TRUE</span></span><br><span class="line">是否在MySQL Server启动时就开启events_statements_summary_by_digest 表的记录功能，启动之后也可以在setup_consumers表中使用<span class="keyword">UPDATE</span>语句进行动态更新digest配置项</span><br><span class="line">默认值为<span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">performance_schema_consumer_thread_instrumentation<span class="operator">=</span><span class="literal">TRUE</span></span><br><span class="line">是否在MySQL Server启动时就开启</span><br><span class="line"></span><br><span class="line">events_xxx_summary_by_yyy_by_event_name表的记录功能，启动之后也可以在setup_consumers表中使用<span class="keyword">UPDATE</span>语句进行动态更新线程配置项</span><br><span class="line">默认值为<span class="literal">TRUE</span></span><br><span class="line"></span><br><span class="line">performance_schema_instrument[<span class="operator">=</span>name]</span><br><span class="line">是否在MySQL Server启动时就启用某些采集器，由于instruments配置项多达数千个，所以该配置项支持key<span class="operator">-</span><span class="keyword">value</span>模式，还支持<span class="operator">%</span>号进行通配等，如下:</span><br><span class="line"></span><br><span class="line"># [<span class="operator">=</span>name]可以指定为具体的Instruments名称（但是这样如果有多个需要指定的时候，就需要使用该选项多次），也可以使用通配符，可以指定instruments相同的前缀<span class="operator">+</span>通配符，也可以使用<span class="operator">%</span>代表所有的instruments</span><br><span class="line"></span><br><span class="line">## 指定开启单个instruments</span><br><span class="line"></span><br><span class="line"><span class="comment">--performance-schema-instrument= &#x27;instrument_name=value&#x27;</span></span><br><span class="line"></span><br><span class="line">## 使用通配符指定开启多个instruments</span><br><span class="line"></span><br><span class="line"><span class="comment">--performance-schema-instrument= &#x27;wait/synch/cond/%=COUNTED&#x27;</span></span><br><span class="line"></span><br><span class="line">## 开关所有的instruments</span><br><span class="line"></span><br><span class="line"><span class="comment">--performance-schema-instrument= &#x27;%=ON&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--performance-schema-instrument= &#x27;%=OFF&#x27;</span></span><br><span class="line"></span><br><span class="line">注意，这些启动选项要生效的前提是，需要设置performance_schema<span class="operator">=</span><span class="keyword">ON</span>。另外，这些启动选项虽然无法使用<span class="keyword">show</span> variables语句查看，但我们可以通过setup_instruments和setup_consumers表查询这些选项指定的值。</span><br></pre></td></tr></table></figure>
<p>2、系统变量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%performance_schema%&#x27;</span>;</span><br><span class="line"><span class="comment">--重要的属性解释</span></span><br><span class="line">performance_schema<span class="operator">=</span><span class="keyword">ON</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">控制performance_schema功能的开关，要使用MySQL的performance_schema，需要在mysqld启动时启用，以启用事件收集功能</span></span><br><span class="line"><span class="comment">该参数在5.7.x之前支持performance_schema的版本中默认关闭，5.7.x版本开始默认开启</span></span><br><span class="line"><span class="comment">注意：如果mysqld在初始化performance_schema时发现无法分配任何相关的内部缓冲区，则performance_schema将自动禁用，并将performance_schema设置为OFF</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">performance_schema_digests_size<span class="operator">=</span><span class="number">10000</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">控制events_statements_summary_by_digest表中的最大行数。如果产生的语句摘要信息超过此最大值，便无法继续存入该表，此时performance_schema会增加状态变量</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">performance_schema_events_statements_history_long_size<span class="operator">=</span><span class="number">10000</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">控制events_statements_history_long表中的最大行数，该参数控制所有会话在events_statements_history_long表中能够存放的总事件记录数，超过这个限制之后，最早的记录将被覆盖</span></span><br><span class="line"><span class="comment">全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10000，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10000 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10000</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">performance_schema_events_statements_history_size<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">控制events_statements_history表中单个线程（会话）的最大行数，该参数控制单个会话在events_statements_history表中能够存放的事件记录数，超过这个限制之后，单个会话最早的记录将被覆盖</span></span><br><span class="line"><span class="comment">全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10</span></span><br><span class="line"><span class="comment">除了statement(语句)事件之外，wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个参数分别进行存储限制配置，有兴趣的同学自行研究，这里不再赘述</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">performance_schema_max_digest_length<span class="operator">=</span><span class="number">1024</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">用于控制标准化形式的SQL语句文本在存入performance_schema时的限制长度，该变量与max_digest_length变量相关(max_digest_length变量含义请自行查阅相关资料)</span></span><br><span class="line"><span class="comment">全局变量，只读变量，默认值1024字节，整型值，取值范围0~1048576</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">performance_schema_max_sql_text_length<span class="operator">=</span><span class="number">1024</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">控制存入events_statements_current，events_statements_history和events_statements_history_long语句事件表中的SQL_TEXT列的最大SQL长度字节数。 超出系统变量performance_schema_max_sql_text_length的部分将被丢弃，不会记录，一般情况下不需要调整该参数，除非被截断的部分与其他SQL比起来有很大差异</span></span><br><span class="line"><span class="comment">全局变量，只读变量，整型值，默认值为1024字节，取值范围为0~1048576，5.7.6版本引入</span></span><br><span class="line"><span class="comment">降低系统变量performance_schema_max_sql_text_length值可以减少内存使用，但如果汇总的SQL中，被截断部分有较大差异，会导致没有办法再对这些有较大差异的SQL进行区分。 增加该系统变量值会增加内存使用，但对于汇总SQL来讲可以更精准地区分不同的部分。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="重要配置表的相关说明">5、重要配置表的相关说明</h3>
<p>​ 配置表之间存在相互关联关系，按照配置影响的先后顺序，可添加为</p>
<figure>
<img src="/2023/06/04/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MYSQL%20performance%20schema%E8%AF%A6%E8%A7%A3//image-20191203125003597.png" alt="image-20191203125003597">
<figcaption aria-hidden="true">image-20191203125003597</figcaption>
</figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">performance_timers表中记录了server中有哪些可用的事件计时器</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    timer_name:表示可用计时器名称，CYCLE是基于CPU周期计数器的定时器</span></span><br><span class="line"><span class="comment">    timer_frequency:表示每秒钟对应的计时器单位的数量,CYCLE计时器的换算值与CPU的频率相关、</span></span><br><span class="line"><span class="comment">    timer_resolution:计时器精度值，表示在每个计时器被调用时额外增加的值</span></span><br><span class="line"><span class="comment">    timer_overhead:表示在使用定时器获取事件时开销的最小周期值</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_timers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">setup_timers表中记录当前使用的事件计时器信息</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    name:计时器类型，对应某个事件类别</span></span><br><span class="line"><span class="comment">    timer_name:计时器类型名称</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> setup_timers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">setup_consumers表中列出了consumers可配置列表项</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    NAME：consumers配置名称</span></span><br><span class="line"><span class="comment">    ENABLED：consumers是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> setup_consumers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">setup_instruments 表列出了instruments 列表配置项，即代表了哪些事件支持被收集：</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    NAME：instruments名称，instruments名称可能具有多个部分并形成层次结构</span></span><br><span class="line"><span class="comment">    ENABLED：instrumetns是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。如果设置为NO，则这个instruments不会被执行，不会产生任何的事件信息</span></span><br><span class="line"><span class="comment">    TIMED：instruments是否收集时间信息，有效值为YES或NO，此列可以使用UPDATE语句修改，如果设置为NO，则这个instruments不会收集时间信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> setup_instruments;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">setup_actors表的初始内容是匹配任何用户和主机，因此对于所有前台线程，默认情况下启用监视和历史事件收集功能</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    HOST：与grant语句类似的主机名，一个具体的字符串名字，或使用“％”表示“任何主机”</span></span><br><span class="line"><span class="comment">    USER：一个具体的字符串名称，或使用“％”表示“任何用户”</span></span><br><span class="line"><span class="comment">    ROLE：当前未使用，MySQL 8.0中才启用角色功能</span></span><br><span class="line"><span class="comment">    ENABLED：是否启用与HOST，USER，ROLE匹配的前台线程的监控功能，有效值为：YES或NO</span></span><br><span class="line"><span class="comment">    HISTORY：是否启用与HOST， USER，ROLE匹配的前台线程的历史事件记录功能，有效值为：YES或NO</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> setup_actors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">setup_objects表控制performance_schema是否监视特定对象。默认情况下，此表的最大行数为100行。</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    OBJECT_TYPE：instruments类型，有效值为：“EVENT”（事件调度器事件）、“FUNCTION”（存储函数）、“PROCEDURE”（存储过程）、“TABLE”（基表）、“TRIGGER”（触发器），TABLE对象类型的配置会影响表I/O事件（wait/io/table/sql/handler instrument）和表锁事件（wait/lock/table/sql/handler instrument）的收集</span></span><br><span class="line"><span class="comment">    OBJECT_SCHEMA：某个监视类型对象涵盖的数据库名称，一个字符串名称，或“％”(表示“任何数据库”)</span></span><br><span class="line"><span class="comment">    OBJECT_NAME：某个监视类型对象涵盖的表名，一个字符串名称，或“％”(表示“任何数据库内的对象”)</span></span><br><span class="line"><span class="comment">    ENABLED：是否开启对某个类型对象的监视功能，有效值为：YES或NO。此列可以修改</span></span><br><span class="line"><span class="comment">    TIMED：是否开启对某个类型对象的时间收集功能，有效值为：YES或NO，此列可以修改</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> setup_objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">threads表对于每个server线程生成一行包含线程相关的信息，</span></span><br><span class="line"><span class="comment">字段解释：</span></span><br><span class="line"><span class="comment">    THREAD_ID：线程的唯一标识符（ID）</span></span><br><span class="line"><span class="comment">    NAME：与server中的线程检测代码相关联的名称(注意，这里不是instruments名称)</span></span><br><span class="line"><span class="comment">    TYPE：线程类型，有效值为：FOREGROUND、BACKGROUND。分别表示前台线程和后台线程</span></span><br><span class="line"><span class="comment">    PROCESSLIST_ID：对应INFORMATION_SCHEMA.PROCESSLIST表中的ID列。</span></span><br><span class="line"><span class="comment">    PROCESSLIST_USER：与前台线程相关联的用户名，对于后台线程为NULL。</span></span><br><span class="line"><span class="comment">    PROCESSLIST_HOST：与前台线程关联的客户端的主机名，对于后台线程为NULL。</span></span><br><span class="line"><span class="comment">    PROCESSLIST_DB：线程的默认数据库，如果没有，则为NULL。</span></span><br><span class="line"><span class="comment">    PROCESSLIST_COMMAND：对于前台线程，该值代表着当前客户端正在执行的command类型，如果是sleep则表示当前会话处于空闲状态</span></span><br><span class="line"><span class="comment">    PROCESSLIST_TIME：当前线程已处于当前线程状态的持续时间（秒）</span></span><br><span class="line"><span class="comment">    PROCESSLIST_STATE：表示线程正在做什么事情。</span></span><br><span class="line"><span class="comment">    PROCESSLIST_INFO：线程正在执行的语句，如果没有执行任何语句，则为NULL。</span></span><br><span class="line"><span class="comment">    PARENT_THREAD_ID：如果这个线程是一个子线程（由另一个线程生成），那么该字段显示其父线程ID</span></span><br><span class="line"><span class="comment">    ROLE：暂未使用</span></span><br><span class="line"><span class="comment">    INSTRUMENTED：线程执行的事件是否被检测。有效值：YES、NO </span></span><br><span class="line"><span class="comment">    HISTORY：是否记录线程的历史事件。有效值：YES、NO * </span></span><br><span class="line"><span class="comment">    THREAD_OS_ID：由操作系统层定义的线程或任务标识符（ID）：</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> threads</span><br></pre></td></tr></table></figure>
<p>注意：在performance_schema库中还包含了很多其他的库和表，能对数据库的性能做完整的监控，大家需要参考官网详细了解。</p>
<h3 id="performance_schema实践操作">6、performance_schema实践操作</h3>
<p>​
基本了解了表的相关信息之后，可以通过这些表进行实际的查询操作来进行实际的分析。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1、哪类的SQL执行最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,COUNT_STAR,FIRST_SEEN,LAST_SEEN <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--2、哪类SQL的平均响应时间最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,AVG_TIMER_WAIT <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--3、哪类SQL排序记录数最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_SORT_ROWS <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--4、哪类SQL扫描记录数最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_EXAMINED <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--5、哪类SQL使用临时表最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_CREATED_TMP_TABLES,SUM_CREATED_TMP_DISK_TABLES <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--6、哪类SQL返回结果集最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_SENT <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--7、哪个表物理IO最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> file_name,event_name,SUM_NUMBER_OF_BYTES_READ,SUM_NUMBER_OF_BYTES_WRITE <span class="keyword">FROM</span> file_summary_by_instance <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_NUMBER_OF_BYTES_READ <span class="operator">+</span> SUM_NUMBER_OF_BYTES_WRITE <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--8、哪个表逻辑IO最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> object_name,COUNT_READ,COUNT_WRITE,COUNT_FETCH,SUM_TIMER_WAIT <span class="keyword">FROM</span> table_io_waits_summary_by_table <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--9、哪个索引访问最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> OBJECT_NAME,INDEX_NAME,COUNT_FETCH,COUNT_INSERT,COUNT_UPDATE,COUNT_DELETE <span class="keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--10、哪个索引从来没有用过？</span></span><br><span class="line"><span class="keyword">SELECT</span> OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME <span class="keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="keyword">WHERE</span> INDEX_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">AND</span> COUNT_STAR <span class="operator">=</span> <span class="number">0</span> <span class="keyword">AND</span> OBJECT_SCHEMA <span class="operator">&lt;&gt;</span> <span class="string">&#x27;mysql&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> OBJECT_SCHEMA,OBJECT_NAME;</span><br><span class="line"><span class="comment">--11、哪个等待事件消耗时间最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_NAME,COUNT_STAR,SUM_TIMER_WAIT,AVG_TIMER_WAIT <span class="keyword">FROM</span> events_waits_summary_global_by_event_name <span class="keyword">WHERE</span> event_name <span class="operator">!=</span> <span class="string">&#x27;idle&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--12-1、剖析某条SQL的执行情况，包括statement信息，stege信息，wait信息</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_ID,sql_text <span class="keyword">FROM</span> events_statements_history <span class="keyword">WHERE</span> sql_text <span class="keyword">LIKE</span> <span class="string">&#x27;%count(*)%&#x27;</span>;</span><br><span class="line"><span class="comment">--12-2、查看每个阶段的时间消耗</span></span><br><span class="line"><span class="keyword">SELECT</span> event_id,EVENT_NAME,SOURCE,TIMER_END <span class="operator">-</span> TIMER_START <span class="keyword">FROM</span> events_stages_history_long <span class="keyword">WHERE</span> NESTING_EVENT_ID <span class="operator">=</span> <span class="number">1553</span>;</span><br><span class="line"><span class="comment">--12-3、查看每个阶段的锁等待情况</span></span><br><span class="line"><span class="keyword">SELECT</span> event_id,event_name,source,timer_wait,object_name,index_name,operation,nesting_event_id <span class="keyword">FROM</span> events_waits_history_longWHERE nesting_event_id <span class="operator">=</span> <span class="number">1553</span>;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-09T18:45:12.000Z" title="2023/5/10 02:45:12">2023-05-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-06-22T07:13:57.276Z" title="2023/6/22 15:13:57">2023-06-22</time></span><span class="level-item"><a class="link-muted" href="">数据库</a></span><span class="level-item">14 minutes read (About 2166 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="../../2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/">mysql执行计划</a></p><div class="content"><h1 id="mysql执行计划">mysql执行计划</h1>
<p>​
在企业的应用场景中，为了知道优化SQL语句的执行，需要查看SQL语句的具体执行过程，以加快SQL语句的执行效率。</p>
<p>​
可以使用explain+SQL语句来模拟优化器执行SQL查询语句，从而知道mysql是如何处理sql语句的。</p>
<p>​ 官网地址：
https://dev.mysql.com/doc/refman/5.5/en/explain-output.html</p>
<h3 id="执行计划中包含的信息">1、执行计划中包含的信息</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Column</th>
<th style="text-align: center;">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">id</td>
<td style="text-align: center;">The <code>SELECT</code> identifier</td>
</tr>
<tr class="even">
<td style="text-align: center;">select_type</td>
<td style="text-align: center;">The <code>SELECT</code> type</td>
</tr>
<tr class="odd">
<td style="text-align: center;">table</td>
<td style="text-align: center;">The table for the output row</td>
</tr>
<tr class="even">
<td style="text-align: center;">partitions</td>
<td style="text-align: center;">The matching partitions</td>
</tr>
<tr class="odd">
<td style="text-align: center;">type</td>
<td style="text-align: center;">The join type</td>
</tr>
<tr class="even">
<td style="text-align: center;">possible_keys</td>
<td style="text-align: center;">The possible indexes to choose</td>
</tr>
<tr class="odd">
<td style="text-align: center;">key</td>
<td style="text-align: center;">The index actually chosen</td>
</tr>
<tr class="even">
<td style="text-align: center;">key_len</td>
<td style="text-align: center;">The length of the chosen key</td>
</tr>
<tr class="odd">
<td style="text-align: center;">ref</td>
<td style="text-align: center;">The columns compared to the index</td>
</tr>
<tr class="even">
<td style="text-align: center;">rows</td>
<td style="text-align: center;">Estimate of rows to be examined</td>
</tr>
<tr class="odd">
<td style="text-align: center;">filtered</td>
<td style="text-align: center;">Percentage of rows filtered by table
condition</td>
</tr>
<tr class="even">
<td style="text-align: center;">extra</td>
<td style="text-align: center;">Additional information</td>
</tr>
</tbody>
</table>
<p><strong>id</strong></p>
<p>select查询的序列号，包含一组数字，表示查询中执行select子句或者操作表的顺序</p>
<p>id号分为三种情况：</p>
<p>​ 1、如果id相同，那么执行顺序从上到下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno <span class="keyword">join</span> salgrade sg <span class="keyword">on</span> e.sal <span class="keyword">between</span> sg.losal <span class="keyword">and</span> sg.hisal;</span><br></pre></td></tr></table></figure>
<p>​
2、如果id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">where</span> e.deptno <span class="keyword">in</span> (<span class="keyword">select</span> d.deptno <span class="keyword">from</span> dept d <span class="keyword">where</span> d.dname <span class="operator">=</span> <span class="string">&#x27;SALES&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>​
3、id相同和不同的，同时存在：相同的可以认为是一组，从上往下顺序执行，在所有组中，id值越大，优先级越高，越先执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno <span class="keyword">join</span> salgrade sg <span class="keyword">on</span> e.sal <span class="keyword">between</span> sg.losal <span class="keyword">and</span> sg.hisal <span class="keyword">where</span> e.deptno <span class="keyword">in</span> (<span class="keyword">select</span> d.deptno <span class="keyword">from</span> dept d <span class="keyword">where</span> d.dname <span class="operator">=</span> <span class="string">&#x27;SALES&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>select_type</strong></p>
<p>主要用来分辨查询的类型，是普通查询还是联合查询还是子查询</p>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 82%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>select_type</code> Value</th>
<th style="text-align: center;">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">SIMPLE</td>
<td style="text-align: center;">Simple SELECT (not using UNION or
subqueries)</td>
</tr>
<tr class="even">
<td style="text-align: center;">PRIMARY</td>
<td style="text-align: center;">Outermost SELECT</td>
</tr>
<tr class="odd">
<td style="text-align: center;">UNION</td>
<td style="text-align: center;">Second or later SELECT statement in a
UNION</td>
</tr>
<tr class="even">
<td style="text-align: center;">DEPENDENT UNION</td>
<td style="text-align: center;">Second or later SELECT statement in a
UNION, dependent on outer query</td>
</tr>
<tr class="odd">
<td style="text-align: center;">UNION RESULT</td>
<td style="text-align: center;">Result of a UNION.</td>
</tr>
<tr class="even">
<td style="text-align: center;">SUBQUERY</td>
<td style="text-align: center;">First SELECT in subquery</td>
</tr>
<tr class="odd">
<td style="text-align: center;">DEPENDENT SUBQUERY</td>
<td style="text-align: center;">First SELECT in subquery, dependent on
outer query</td>
</tr>
<tr class="even">
<td style="text-align: center;">DERIVED</td>
<td style="text-align: center;">Derived table</td>
</tr>
<tr class="odd">
<td style="text-align: center;">UNCACHEABLE SUBQUERY</td>
<td style="text-align: center;">A subquery for which the result cannot
be cached and must be re-evaluated for each row of the outer query</td>
</tr>
<tr class="even">
<td style="text-align: center;">UNCACHEABLE UNION</td>
<td style="text-align: center;">The second or later select in a UNION
that belongs to an uncacheable subquery (see UNCACHEABLE SUBQUERY)</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--sample:简单的查询，不包含子查询和union</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">--primary:查询中若包含任何复杂的子查询，最外层查询则被标记为Primary</span></span><br><span class="line">explain <span class="keyword">select</span> staname,ename supname <span class="keyword">from</span> (<span class="keyword">select</span> ename staname,mgr <span class="keyword">from</span> emp) t <span class="keyword">join</span> emp <span class="keyword">on</span> t.mgr<span class="operator">=</span>emp.empno ;</span><br><span class="line"></span><br><span class="line"><span class="comment">--union:若第二个select出现在union之后，则被标记为union</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">10</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="operator">&gt;</span><span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--dependent union:跟union类似，此处的depentent表示union或union all联合而成的结果会受外部表影响</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">where</span> e.empno  <span class="keyword">in</span> ( <span class="keyword">select</span> empno <span class="keyword">from</span> emp <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">10</span> <span class="keyword">union</span> <span class="keyword">select</span> empno <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="operator">&gt;</span><span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--union result:从union表获取结果的select</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">10</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="operator">&gt;</span><span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--subquery:在select或者where列表中包含子查询</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="operator">&gt;</span> (<span class="keyword">select</span> <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">--dependent subquery:subquery的子查询要受到外部表查询的影响</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">where</span> e.deptno <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> deptno <span class="keyword">from</span> dept);</span><br><span class="line"></span><br><span class="line"><span class="comment">--DERIVED: from子句中出现的子查询，也叫做派生类，</span></span><br><span class="line">explain <span class="keyword">select</span> staname,ename supname <span class="keyword">from</span> (<span class="keyword">select</span> ename staname,mgr <span class="keyword">from</span> emp) t <span class="keyword">join</span> emp <span class="keyword">on</span> t.mgr<span class="operator">=</span>emp.empno ;</span><br><span class="line"></span><br><span class="line"><span class="comment">--UNCACHEABLE SUBQUERY：表示使用子查询的结果不能被缓存</span></span><br><span class="line"> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">=</span> (<span class="keyword">select</span> empno <span class="keyword">from</span> emp <span class="keyword">where</span> deptno<span class="operator">=</span>@<span class="variable">@sort_buffer_size</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--uncacheable union:表示union的查询结果不能被缓存：sql语句未验证</span></span><br></pre></td></tr></table></figure>
<p><strong>table</strong></p>
<p>对应行正在访问哪一个表，表名或者别名，可能是临时表或者union合并结果集
1、如果是具体的表名，则表明从实际的物理表中获取数据，当然也可以是表的别名</p>
<p>​ 2、表名是derivedN的形式，表示使用了id为N的查询产生的衍生表</p>
<p>​ 3、当有union result的时候，表名是union
n1,n2等的形式，n1,n2表示参与union的id</p>
<p><strong>type</strong></p>
<p>type显示的是访问类型，访问类型表示我是以何种方式去访问我们的数据，最容易想的是全表扫描，直接暴力的遍历一张表去寻找需要的数据，效率非常低下，访问的类型有很多，效率从最好到最坏依次是：</p>
<p>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null
&gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range
&gt; index &gt; ALL</p>
<p>一般情况下，得保证查询至少达到range级别，最好能达到ref</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--all:全表扫描，一般情况下出现这样的sql语句而且数据量比较大的话那么就需要进行优化。</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">--index：全索引扫描这个比all的效率要好，主要有两种情况，一种是当前的查询时覆盖索引，即我们需要的数据在索引中就可以索取，或者是使用了索引进行排序，这样就避免数据的重排序</span></span><br><span class="line">explain  <span class="keyword">select</span> empno <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">--range：表示利用索引查询的时候限制了范围，在指定范围内进行查询，这样避免了index的全索引扫描，适用的操作符： =, &lt;&gt;, &gt;, &gt;=, &lt;, &lt;=, IS NULL, BETWEEN, LIKE, or IN() </span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="keyword">between</span> <span class="number">7000</span> <span class="keyword">and</span> <span class="number">7500</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--index_subquery：利用索引来关联子查询，不再扫描全表</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> emp.job <span class="keyword">in</span> (<span class="keyword">select</span> job <span class="keyword">from</span> t_job);</span><br><span class="line"></span><br><span class="line"><span class="comment">--unique_subquery:该连接类型类似与index_subquery,使用的是唯一索引</span></span><br><span class="line"> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">where</span> e.deptno <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> deptno <span class="keyword">from</span> dept);</span><br><span class="line"></span><br><span class="line"><span class="comment">--index_merge：在查询过程中需要多个索引组合使用，没有模拟出来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--ref_or_null：对于某个字段即需要关联条件，也需要null值的情况下，查询优化器会选择这种访问方式</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e <span class="keyword">where</span>  e.mgr <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">or</span> e.mgr<span class="operator">=</span><span class="number">7369</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--ref：使用了非唯一性索引进行数据的查找</span></span><br><span class="line"> <span class="keyword">create</span> index idx_3 <span class="keyword">on</span> emp(deptno);</span><br><span class="line"> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e,dept d <span class="keyword">where</span> e.deptno <span class="operator">=</span>d.deptno;</span><br><span class="line"></span><br><span class="line"><span class="comment">--eq_ref ：使用唯一性索引进行数据查找</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp,emp2 <span class="keyword">where</span> emp.empno <span class="operator">=</span> emp2.empno;</span><br><span class="line"></span><br><span class="line"><span class="comment">--const：这个表至多有一个匹配行，</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">=</span> <span class="number">7369</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--system：表只有一行记录（等于系统表），这是const类型的特例，平时不会出现</span></span><br></pre></td></tr></table></figure>
<p><strong>possible_keys</strong></p>
<p>​
显示可能应用在这张表中的索引，一个或多个，查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp,dept <span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno <span class="keyword">and</span> emp.deptno <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><strong>key</strong></p>
<p>​
实际使用的索引，如果为null，则没有使用索引，查询中若使用了覆盖索引，则该索引和查询的select字段重叠。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp,dept <span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno <span class="keyword">and</span> emp.deptno <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><strong>key_len</strong></p>
<p>表示索引中使用的字节数，可以通过key_len计算查询中使用的索引长度，在不损失精度的情况下长度越短越好。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp,dept <span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno <span class="keyword">and</span> emp.deptno <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><strong>ref</strong></p>
<p>显示索引的哪一列被使用了，如果可能的话，是一个常数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp,dept <span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno <span class="keyword">and</span> emp.deptno <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p><strong>rows</strong></p>
<p>根据表的统计信息及索引使用情况，大致估算出找出所需记录需要读取的行数，此参数很重要，直接反应的sql找了多少数据，在完成目的的情况下越少越好</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>
<p><strong>extra</strong></p>
<p>包含额外的信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--using filesort:说明mysql无法利用索引进行排序，只能利用排序算法进行排序，会消耗额外的位置</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> sal;</span><br><span class="line"></span><br><span class="line"><span class="comment">--using temporary:建立临时表来保存中间结果，查询完成之后把临时表删除</span></span><br><span class="line">explain <span class="keyword">select</span> ename,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp <span class="keyword">where</span> deptno <span class="operator">=</span> <span class="number">10</span> <span class="keyword">group</span> <span class="keyword">by</span> ename;</span><br><span class="line"></span><br><span class="line"><span class="comment">--using index:这个表示当前的查询时覆盖索引的，直接从索引中读取数据，而不用访问数据表。如果同时出现using where 表名索引被用来执行索引键值的查找，如果没有，表面索引被用来读取数据，而不是真的查找</span></span><br><span class="line">explain <span class="keyword">select</span> deptno,<span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno limit <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--using where:使用where进行条件过滤</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_user <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--using join buffer:使用连接缓存，情况没有模拟出来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--impossible where：where语句的结果总是false</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> empno <span class="operator">=</span> <span class="number">7469</span>;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-09T18:45:12.000Z" title="2023/5/10 02:45:12">2023-05-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-06-22T08:28:37.236Z" title="2023/6/22 16:28:37">2023-06-22</time></span><span class="level-item"><a class="link-muted" href="">数据库</a></span><span class="level-item">an hour read (About 7040 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="../../2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph/">k8s安装部署nebulaGraph</a></p><div class="content"><h1 id="k8s集群安装nebulagraph部署">k8s集群安装&amp;nebulaGraph部署</h1>
<h2 id="一集群环境准备">一，集群环境准备</h2>
<ul>
<li><p>集群规划</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#把xxx替换为对应的主机名</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">222.141</span> node1</span><br><span class="line"><span class="number">192.168</span>.<span class="number">222.142</span> node2</span><br><span class="line"><span class="number">192.168</span>.<span class="number">222.143</span> node3</span><br></pre></td></tr></table></figure></li>
<li><p>配置静态ip</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/sysconfig/network-scripts/ifcfg-enss3</span></span><br><span class="line"><span class="comment">#添加如下内容：所有集群都是</span></span><br><span class="line">IPADDR=<span class="string">&quot;192.168.222.XXX&quot;</span></span><br><span class="line">PREFIX=<span class="string">&quot;24&quot;</span></span><br><span class="line">GATEWAY=<span class="string">&quot;192.168.222.x&quot;</span></span><br><span class="line">DNS1=<span class="string">&quot;119.29.29.29&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>配置主机名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl <span class="built_in">set-hostname</span> xxx</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">222.141</span> node1</span><br><span class="line"><span class="number">192.168</span>.<span class="number">222.142</span> node2</span><br><span class="line"><span class="number">192.168</span>.<span class="number">222.143</span> node3</span><br></pre></td></tr></table></figure></li>
<li><p>配置ip_forward及过滤机制</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.ip_forward = <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="literal">-nf-call-ip6tables</span> = <span class="number">1</span></span><br><span class="line">net.bridge.bridge<span class="literal">-nf-call-iptables</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p>```powershell modprobe br_netfilter <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* ```powershell</span><br><span class="line">  sysctl -p /etc/sysctl.conf</span><br></pre></td></tr></table></figure></p></li>
<li><p>防火墙</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl stop firewalld</span></span><br><span class="line"><span class="comment"># systemctl disable firewalld</span></span><br></pre></td></tr></table></figure></li>
<li><p>selinux</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">永久关闭，一定要重启操作系统后生效。</span><br><span class="line">sed <span class="literal">-ri</span> <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure></li>
<li><p>主机swap分区设置</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="literal">-ri</span> <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure></li>
<li><p>时间同步</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># yum -y install ntpdate</span></span><br><span class="line">  <span class="comment"># crontab -e</span></span><br><span class="line"><span class="number">0</span> */<span class="number">1</span> * * *  ntpdate time1.aliyun.com</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="二docker部署">二、Docker部署</h2>
<blockquote>
<p>所有主机均要配置</p>
</blockquote>
<h3 id="配置docker-yum源">2.1 配置Docker YUM源</h3>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220130193936921.png" alt="image-20220130193936921">
<figcaption aria-hidden="true">image-20220130193936921</figcaption>
</figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br></pre></td></tr></table></figure>
<h3 id="安装docker-ce">2.2 安装Docker CE</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  yum install docker-ce-18.09.8-3.el7.x86_64 -y</span></span><br></pre></td></tr></table></figure>
<h3 id="启动docker服务">2.3 启动Docker服务</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl enable docker</span></span><br><span class="line"><span class="comment"># systemctl start docker</span></span><br></pre></td></tr></table></figure>
<h3 id="配置docker容器镜像加速器">2.4 配置Docker容器镜像加速器</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line"><span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://s27w6kze.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三docker-compose安装">三、docker compose安装</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl -L &quot;https://github.com/docker/compose/releases/download/1.28.5/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose --version</span></span><br></pre></td></tr></table></figure>
<h2 id="四添加rancher用户">四、添加rancher用户</h2>
<blockquote>
<p>使用CentOS时，不能使用 root 账号，因此要添加专用的账号进行 docker相关
操作。</p>
</blockquote>
<blockquote>
<p>所有集群主机均需要操作</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># useradd rancher</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># usermod -aG docker rancher</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 123 | passwd --stdin rancher</span></span><br></pre></td></tr></table></figure>
<h2 id="五生成ssh证书用于部署集群">五、生成ssh证书用于部署集群</h2>
<blockquote>
<p>rke二进制文件安装主机上创建密钥，即为control主机，用于部署集群。</p>
</blockquote>
<h3 id="生成ssh证书">5.1 生成ssh证书</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-keygen</span></span><br></pre></td></tr></table></figure>
<h3 id="复制证书到集群中所有主机">5.2 复制证书到集群中所有主机</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改文件夹所属用户及所属组</span></span><br><span class="line">chown <span class="literal">-R</span> rancher:rancher /home/rancher</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-copy-id rancher@master01</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-copy-id rancher@master02</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-copy-id rancher@worker01</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-copy-id rancher@worker02</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh-copy-id rancher@etcd01</span></span><br></pre></td></tr></table></figure>
<h3 id="验证ssh证书是否可用">5.3 验证ssh证书是否可用</h3>
<blockquote>
<p>本次在master01上部署rke二进制文件。</p>
</blockquote>
<blockquote>
<p>在rke二进制文件安装主机机测试连接其它集群主机，验证是否可使用docker
ps命令即可。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh rancher@主机名</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">远程主机<span class="comment"># docker ps</span></span><br></pre></td></tr></table></figure>
<h2 id="六rke工具下载">六、rke工具下载</h2>
<blockquote>
<p>本次在master01上部署rke二进制文件。</p>
</blockquote>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222170808926.png" alt="image-20220222170808926">
<figcaption aria-hidden="true">image-20220222170808926</figcaption>
</figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/rancher/rke/releases/download/v1.3.7/rke_linux-amd64</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mv rke_linux-amd64 /usr/local/bin/rke</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chmod +x /usr/local/bin/rke</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rke --version</span></span><br><span class="line">rke version v1.<span class="number">3.7</span></span><br></pre></td></tr></table></figure>
<h2 id="七初始化rke配置文件">七、初始化rke配置文件</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /app/rancher</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /app/rancher</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rke config --name cluster.yml</span></span><br><span class="line">[+] Cluster Level SSH Private Key Path [~/<span class="type">.ssh</span>/<span class="type">id_rsa</span>]: 集群私钥路径</span><br><span class="line">[+] Number of Hosts [<span class="number">1</span>]: <span class="number">3</span> 集群中有<span class="number">3</span>个节点</span><br><span class="line">[+] SSH Address of host (<span class="number">1</span>) [<span class="type">none</span>]: <span class="number">192.168</span>.<span class="number">10.10</span> 第一个节点IP地址</span><br><span class="line">[+] SSH Port of host (<span class="number">1</span>) [<span class="number">22</span>]: <span class="number">22</span> 第一个节点SSH访问端口</span><br><span class="line">[+] SSH Private Key Path of host (<span class="number">192.168</span>.<span class="number">10.10</span>) [<span class="type">none</span>]: ~/.ssh/id_rsa 第一个节点私钥路径</span><br><span class="line">[+] SSH User of host (<span class="number">192.168</span>.<span class="number">10.10</span>) [<span class="type">ubuntu</span>]: rancher 远程用户名</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.10</span>) a Control Plane host (y/n)? [<span class="type">y</span>]: y 是否为k8s集群控制节点</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.10</span>) a Worker host (y/n)? [<span class="type">n</span>]: n 不是worker节点</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.10</span>) an etcd host (y/n)? [<span class="type">n</span>]: n 不是etcd节点</span><br><span class="line">[+] Override Hostname of host (<span class="number">192.168</span>.<span class="number">10.10</span>) [<span class="type">none</span>]: 不覆盖现有主机名</span><br><span class="line">[+] Internal IP of host (<span class="number">192.168</span>.<span class="number">10.10</span>) [<span class="type">none</span>]: 主机局域网IP地址</span><br><span class="line">[+] Docker socket path on host (<span class="number">192.168</span>.<span class="number">10.10</span>) [/<span class="type">var</span>/<span class="type">run</span>/<span class="type">docker.sock</span>]: 主机上docker.sock路径</span><br><span class="line">[+] SSH Address of host (<span class="number">2</span>) [<span class="type">none</span>]: <span class="number">192.168</span>.<span class="number">10.12</span> 第二个节点</span><br><span class="line">[+] SSH Port of host (<span class="number">2</span>) [<span class="number">22</span>]: <span class="number">22</span> 远程端口</span><br><span class="line">[+] SSH Private Key Path of host (<span class="number">192.168</span>.<span class="number">10.12</span>) [<span class="type">none</span>]: ~/.ssh/id_rsa 私钥路径</span><br><span class="line">[+] SSH User of host (<span class="number">192.168</span>.<span class="number">10.12</span>) [<span class="type">ubuntu</span>]: rancher 远程访问用户</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.12</span>) a Control Plane host (y/n)? [<span class="type">y</span>]: n 不是控制节点</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.12</span>) a Worker host (y/n)? [<span class="type">n</span>]: y 是worker节点</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.12</span>) an etcd host (y/n)? [<span class="type">n</span>]: n 不是etcd节点</span><br><span class="line">[+] Override Hostname of host (<span class="number">192.168</span>.<span class="number">10.12</span>) [<span class="type">none</span>]: 不覆盖现有主机名</span><br><span class="line">[+] Internal IP of host (<span class="number">192.168</span>.<span class="number">10.12</span>) [<span class="type">none</span>]: 主机局域网IP地址</span><br><span class="line">[+] Docker socket path on host (<span class="number">192.168</span>.<span class="number">10.12</span>) [/<span class="type">var</span>/<span class="type">run</span>/<span class="type">docker.sock</span>]: 主机上docker.sock路径</span><br><span class="line">[+] SSH Address of host (<span class="number">3</span>) [<span class="type">none</span>]: <span class="number">192.168</span>.<span class="number">10.14</span> 第三个节点</span><br><span class="line">[+] SSH Port of host (<span class="number">3</span>) [<span class="number">22</span>]: <span class="number">22</span> 远程端口</span><br><span class="line">[+] SSH Private Key Path of host (<span class="number">192.168</span>.<span class="number">10.14</span>) [<span class="type">none</span>]: ~/.ssh/id_rsa 私钥路径</span><br><span class="line">[+] SSH User of host (<span class="number">192.168</span>.<span class="number">10.14</span>) [<span class="type">ubuntu</span>]: rancher 远程访问用户</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.14</span>) a Control Plane host (y/n)? [<span class="type">y</span>]: n 不是控制节点</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.14</span>) a Worker host (y/n)? [<span class="type">n</span>]: n 不是worker节点</span><br><span class="line">[+] Is host (<span class="number">192.168</span>.<span class="number">10.14</span>) an etcd host (y/n)? [<span class="type">n</span>]: y 是etcd节点</span><br><span class="line">[+] Override Hostname of host (<span class="number">192.168</span>.<span class="number">10.14</span>) [<span class="type">none</span>]: 不覆盖现有主机名</span><br><span class="line">[+] Internal IP of host (<span class="number">192.168</span>.<span class="number">10.14</span>) [<span class="type">none</span>]: 主机局域网IP地址</span><br><span class="line">[+] Docker socket path on host (<span class="number">192.168</span>.<span class="number">10.14</span>) [/<span class="type">var</span>/<span class="type">run</span>/<span class="type">docker.sock</span>]: 主机上docker.sock路径</span><br><span class="line">[+] Network Plugin <span class="built_in">Type</span> (flannel, calico, weave, canal, aci) [<span class="type">canal</span>]: 使用的网络插件</span><br><span class="line">[+] Authentication Strategy [<span class="type">x509</span>]: 认证策略</span><br><span class="line">[+] Authorization Mode (rbac, none) [<span class="type">rbac</span>]: 认证模式</span><br><span class="line">[+] Kubernetes Docker image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>]: 集群容器镜像</span><br><span class="line">[+] Cluster domain [<span class="type">cluster.local</span>]: 集群域名</span><br><span class="line">[+] Service Cluster IP Range [<span class="number">10.43</span><span class="type">.0.0</span>/<span class="number">16</span>]: 集群中Servic IP地址范围</span><br><span class="line">[+] Enable PodSecurityPolicy [<span class="type">n</span>]: 是否开启Pod安装策略</span><br><span class="line">[+] Cluster Network CIDR [<span class="number">10.42</span><span class="type">.0.0</span>/<span class="number">16</span>]: 集群Pod网络</span><br><span class="line">[+] Cluster DNS Service IP [<span class="number">10.43</span><span class="type">.0.10</span>]: 集群DNS Service IP地址</span><br><span class="line">[+] Add addon manifest URLs or YAML files [<span class="type">no</span>]: 是否增加插件manifest URL或配置文件</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> <span class="type">rancher</span>]<span class="comment"># ls</span></span><br><span class="line">cluster.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在cluster.yaml文件中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kube<span class="literal">-controller</span>:</span><br><span class="line">image: <span class="string">&quot;&quot;</span></span><br><span class="line">extra_args:</span><br><span class="line"><span class="comment"># 如果后面需要部署kubeflow或istio则一定要配置以下参数</span></span><br><span class="line">cluster<span class="literal">-signing-cert-file</span>: <span class="string">&quot;/etc/kubernetes/ssl/kube-ca.pem&quot;</span></span><br><span class="line">cluster<span class="literal">-signing-key-file</span>: <span class="string">&quot;/etc/kubernetes/ssl/kube-ca-key.pem&quot;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="八集群部署">八、集群部署</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pwd</span></span><br><span class="line">/app/rancher</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rke up</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line">输出：</span><br><span class="line">INFO[<span class="number">0000</span>] Running RKE version: v1.<span class="number">3.7</span></span><br><span class="line">INFO[<span class="number">0000</span>] Initiating Kubernetes cluster</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">dialer</span>] Setup tunnel <span class="keyword">for</span> host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">dialer</span>] Setup tunnel <span class="keyword">for</span> host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">dialer</span>] Setup tunnel <span class="keyword">for</span> host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0000</span>] Checking <span class="keyword">if</span> container [<span class="type">cluster</span>-<span class="type">state</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0000</span>] Checking <span class="keyword">if</span> container [<span class="type">cluster</span>-<span class="type">state</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0000</span>] Checking <span class="keyword">if</span> container [<span class="type">cluster</span>-<span class="type">state</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating CA kubernetes certificates</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating Kubernetes API server aggregation layer requestheader client CA certificates</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] GenerateServingCertificate is disabled, checking <span class="keyword">if</span> there are unused kubelet certificates</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating Kubernetes API server certificates</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating Service account token key</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating Kube Controller certificates</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating Kube Scheduler certificates</span><br><span class="line">INFO[<span class="number">0000</span>] [<span class="type">certificates</span>] Generating Kube Proxy certificates</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">certificates</span>] Generating Node certificate</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">certificates</span>] Generating admin certificates and kubeconfig</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">certificates</span>] Generating Kubernetes API server proxy client certificates</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">certificates</span>] Generating kube<span class="literal">-etcd-192-168-10-14</span> certificate and key</span><br><span class="line">INFO[<span class="number">0001</span>] Successfully Deployed state file at [<span class="type">.</span>/<span class="type">cluster.rkestate</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] Building Kubernetes cluster</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">dialer</span>] Setup tunnel <span class="keyword">for</span> host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">dialer</span>] Setup tunnel <span class="keyword">for</span> host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">dialer</span>] Setup tunnel <span class="keyword">for</span> host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">network</span>] Deploying port listener containers</span><br><span class="line">INFO[<span class="number">0001</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] Starting container [<span class="type">rke</span>-<span class="type">etcd</span>-<span class="type">port</span>-<span class="type">listener</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0001</span>] [<span class="type">network</span>] Successfully started [<span class="type">rke</span>-<span class="type">etcd</span>-<span class="type">port</span>-<span class="type">listener</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0001</span>] Starting container [<span class="type">rke</span>-<span class="type">cp</span>-<span class="type">port</span>-<span class="type">listener</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Successfully started [<span class="type">rke</span>-<span class="type">cp</span>-<span class="type">port</span>-<span class="type">listener</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0002</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0002</span>] Starting container [<span class="type">rke</span>-<span class="type">worker</span>-<span class="type">port</span>-<span class="type">listener</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Successfully started [<span class="type">rke</span>-<span class="type">worker</span>-<span class="type">port</span>-<span class="type">listener</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Port listener containers deployed successfully</span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Running control plane -&gt; etcd port checks</span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Checking <span class="keyword">if</span> host [<span class="number">192.168</span><span class="type">.10.10</span>] can connect to host(s) [<span class="number">192.168</span><span class="type">.10.14</span>] on port(s) [<span class="number">2379</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0002</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0002</span>] Starting container [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Successfully started [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0002</span>] Removing container [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Running control plane -&gt; worker port checks</span><br><span class="line">INFO[<span class="number">0002</span>] [<span class="type">network</span>] Checking <span class="keyword">if</span> host [<span class="number">192.168</span><span class="type">.10.10</span>] can connect to host(s) [<span class="number">192.168</span><span class="type">.10.12</span>] on port(s) [<span class="number">10250</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0002</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Starting container [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Successfully started [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Removing container [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Running workers -&gt; control plane port checks</span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Checking <span class="keyword">if</span> host [<span class="number">192.168</span><span class="type">.10.12</span>] can connect to host(s) [<span class="number">192.168</span><span class="type">.10.10</span>] on port(s) [<span class="number">6443</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Starting container [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Successfully started [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Removing container [<span class="type">rke</span>-<span class="type">port</span>-<span class="type">checker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Checking KubeAPI port Control Plane hosts</span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Removing port listener containers</span><br><span class="line">INFO[<span class="number">0003</span>] Removing container [<span class="type">rke</span>-<span class="type">etcd</span>-<span class="type">port</span>-<span class="type">listener</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">etcd</span>-<span class="type">port</span>-<span class="type">listener</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Removing container [<span class="type">rke</span>-<span class="type">cp</span>-<span class="type">port</span>-<span class="type">listener</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">cp</span>-<span class="type">port</span>-<span class="type">listener</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Removing container [<span class="type">rke</span>-<span class="type">worker</span>-<span class="type">port</span>-<span class="type">listener</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">worker</span>-<span class="type">port</span>-<span class="type">listener</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">network</span>] Port listener containers removed successfully</span><br><span class="line">INFO[<span class="number">0003</span>] [<span class="type">certificates</span>] Deploying kubernetes certificates to Cluster nodes</span><br><span class="line">INFO[<span class="number">0003</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0003</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0003</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0004</span>] Starting container [<span class="type">cert</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0004</span>] Starting container [<span class="type">cert</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0004</span>] Starting container [<span class="type">cert</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0004</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0004</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0004</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Removing container [<span class="type">cert</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Removing container [<span class="type">cert</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Checking <span class="keyword">if</span> container [<span class="type">cert</span>-<span class="type">deployer</span>] is running on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Removing container [<span class="type">cert</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] [<span class="type">reconcile</span>] Rebuilding and updating local kube config</span><br><span class="line">INFO[<span class="number">0009</span>] Successfully Deployed local admin kubeconfig at [<span class="type">.</span>/<span class="type">kube_config_cluster.yml</span>]</span><br><span class="line">WARN[<span class="number">0009</span>] [<span class="type">reconcile</span>] host [<span class="number">192.168</span><span class="type">.10.10</span>] is a control plane node without reachable Kubernetes API endpoint <span class="keyword">in</span> the cluster</span><br><span class="line">WARN[<span class="number">0009</span>] [<span class="type">reconcile</span>] no control plane node with reachable Kubernetes API endpoint <span class="keyword">in</span> the cluster found</span><br><span class="line">INFO[<span class="number">0009</span>] [<span class="type">certificates</span>] Successfully deployed kubernetes certificates to Cluster nodes</span><br><span class="line">INFO[<span class="number">0009</span>] [<span class="type">file</span>-<span class="type">deploy</span>] Deploying file [/<span class="type">etc</span>/<span class="type">kubernetes</span>/<span class="type">audit</span>-<span class="type">policy.yaml</span>] to node [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0009</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0009</span>] Starting container [<span class="type">file</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0009</span>] Successfully started [<span class="type">file</span>-<span class="type">deployer</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0009</span>] Waiting <span class="keyword">for</span> [<span class="type">file</span>-<span class="type">deployer</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0009</span>] Waiting <span class="keyword">for</span> [<span class="type">file</span>-<span class="type">deployer</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0009</span>] Container [<span class="type">file</span>-<span class="type">deployer</span>] is still running on host [<span class="number">192.168</span><span class="type">.10.10</span>]: stderr: [], stdout: []</span><br><span class="line">INFO[<span class="number">0010</span>] Waiting <span class="keyword">for</span> [<span class="type">file</span>-<span class="type">deployer</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0010</span>] Removing container [<span class="type">file</span>-<span class="type">deployer</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0010</span>] [<span class="type">remove</span>/<span class="type">file</span>-<span class="type">deployer</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0010</span>] [/<span class="type">etc</span>/<span class="type">kubernetes</span>/<span class="type">audit</span>-<span class="type">policy.yaml</span>] Successfully deployed audit policy file to Cluster control nodes</span><br><span class="line">INFO[<span class="number">0010</span>] [<span class="type">reconcile</span>] Reconciling cluster state</span><br><span class="line">INFO[<span class="number">0010</span>] [<span class="type">reconcile</span>] This is newly generated cluster</span><br><span class="line">INFO[<span class="number">0010</span>] Pre<span class="literal">-pulling</span> kubernetes images</span><br><span class="line">INFO[<span class="number">0010</span>] Pulling image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0010</span>] Pulling image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0010</span>] Pulling image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0087</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0090</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0092</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0092</span>] Kubernetes images pulled successfully</span><br><span class="line">INFO[<span class="number">0092</span>] [<span class="type">etcd</span>] Building up etcd plane..</span><br><span class="line">INFO[<span class="number">0092</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0092</span>] Starting container [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0092</span>] Successfully started [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0092</span>] Waiting <span class="keyword">for</span> [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0092</span>] Waiting <span class="keyword">for</span> [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0092</span>] Container [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] is still running on host [<span class="number">192.168</span><span class="type">.10.14</span>]: stderr: [], stdout: []</span><br><span class="line">INFO[<span class="number">0093</span>] Waiting <span class="keyword">for</span> [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0093</span>] Removing container [<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0093</span>] [<span class="type">remove</span>/<span class="type">etcd</span>-<span class="type">fix</span>-<span class="type">perm</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0093</span>] Image [<span class="type">rancher</span>/<span class="type">mirrored</span>-<span class="type">coreos</span>-<span class="type">etcd</span>:<span class="type">v3.5.0</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0093</span>] Starting container [<span class="type">etcd</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0093</span>] [<span class="type">etcd</span>] Successfully started [<span class="type">etcd</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0093</span>] [<span class="type">etcd</span>] Running rolling snapshot container [<span class="type">etcd</span>-<span class="type">snapshot</span>-<span class="type">once</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0093</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0094</span>] Starting container [<span class="type">etcd</span>-<span class="type">rolling</span>-<span class="type">snapshots</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0094</span>] [<span class="type">etcd</span>] Successfully started [<span class="type">etcd</span>-<span class="type">rolling</span>-<span class="type">snapshots</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0099</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0099</span>] Starting container [<span class="type">rke</span>-<span class="type">bundle</span>-<span class="type">cert</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0099</span>] [<span class="type">certificates</span>] Successfully started [<span class="type">rke</span>-<span class="type">bundle</span>-<span class="type">cert</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0099</span>] Waiting <span class="keyword">for</span> [<span class="type">rke</span>-<span class="type">bundle</span>-<span class="type">cert</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0099</span>] Container [<span class="type">rke</span>-<span class="type">bundle</span>-<span class="type">cert</span>] is still running on host [<span class="number">192.168</span><span class="type">.10.14</span>]: stderr: [], stdout: []</span><br><span class="line">INFO[<span class="number">0100</span>] Waiting <span class="keyword">for</span> [<span class="type">rke</span>-<span class="type">bundle</span>-<span class="type">cert</span>] container to <span class="keyword">exit</span> on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0100</span>] [<span class="type">certificates</span>] successfully saved certificate bundle [/<span class="type">opt</span>/<span class="type">rke</span>/<span class="type">etcd</span>-<span class="type">snapshots</span>//<span class="type">pki.bundle.tar.gz</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0100</span>] Removing container [<span class="type">rke</span>-<span class="type">bundle</span>-<span class="type">cert</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0100</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0100</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0100</span>] [<span class="type">etcd</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0100</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0100</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0100</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0101</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">etcd</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0101</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">etcd</span>] Successfully started etcd plane.. Checking etcd cluster health</span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">etcd</span>] etcd host [<span class="number">192.168</span><span class="type">.10.14</span>] reported healthy=true</span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">controlplane</span>] Building up Controller Plane..</span><br><span class="line">INFO[<span class="number">0101</span>] Checking <span class="keyword">if</span> container [<span class="type">service</span>-<span class="type">sidekick</span>] is running on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0101</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0101</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0101</span>] Starting container [<span class="type">kube</span>-<span class="type">apiserver</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">controlplane</span>] Successfully started [<span class="type">kube</span>-<span class="type">apiserver</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0101</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kube</span>-<span class="type">apiserver</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0106</span>] [<span class="type">healthcheck</span>] service [<span class="type">kube</span>-<span class="type">apiserver</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>] is healthy</span><br><span class="line">INFO[<span class="number">0106</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0107</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0107</span>] [<span class="type">controlplane</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0107</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0107</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0107</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0107</span>] Starting container [<span class="type">kube</span>-<span class="type">controller</span>-<span class="type">manager</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0107</span>] [<span class="type">controlplane</span>] Successfully started [<span class="type">kube</span>-<span class="type">controller</span>-<span class="type">manager</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0107</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kube</span>-<span class="type">controller</span>-<span class="type">manager</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0112</span>] [<span class="type">healthcheck</span>] service [<span class="type">kube</span>-<span class="type">controller</span>-<span class="type">manager</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>] is healthy</span><br><span class="line">INFO[<span class="number">0112</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0113</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0113</span>] [<span class="type">controlplane</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0113</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0113</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0113</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0113</span>] Starting container [<span class="type">kube</span>-<span class="type">scheduler</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0113</span>] [<span class="type">controlplane</span>] Successfully started [<span class="type">kube</span>-<span class="type">scheduler</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0113</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kube</span>-<span class="type">scheduler</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0118</span>] [<span class="type">healthcheck</span>] service [<span class="type">kube</span>-<span class="type">scheduler</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>] is healthy</span><br><span class="line">INFO[<span class="number">0118</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">controlplane</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">controlplane</span>] Successfully started Controller Plane..</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">authz</span>] Creating rke<span class="literal">-job-deployer</span> ServiceAccount</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">authz</span>] rke<span class="literal">-job-deployer</span> ServiceAccount created successfully</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">authz</span>] Creating system:node ClusterRoleBinding</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">authz</span>] system:node ClusterRoleBinding created successfully</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">authz</span>] Creating kube<span class="literal">-apiserver</span> proxy ClusterRole and ClusterRoleBinding</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">authz</span>] kube<span class="literal">-apiserver</span> proxy ClusterRole and ClusterRoleBinding created successfully</span><br><span class="line">INFO[<span class="number">0119</span>] Successfully Deployed state file at [<span class="type">.</span>/<span class="type">cluster.rkestate</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">state</span>] Saving full cluster state to Kubernetes</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">state</span>] Successfully Saved full cluster state to Kubernetes ConfigMap: full<span class="literal">-cluster-state</span></span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">worker</span>] Building up Worker Plane..</span><br><span class="line">INFO[<span class="number">0119</span>] Checking <span class="keyword">if</span> container [<span class="type">service</span>-<span class="type">sidekick</span>] is running on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0119</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">sidekick</span>] Sidekick container already created on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Starting container [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">worker</span>] Successfully started [<span class="type">kubelet</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Starting container [<span class="type">nginx</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">worker</span>] Successfully started [<span class="type">nginx</span>-<span class="type">proxy</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Starting container [<span class="type">nginx</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0119</span>] [<span class="type">worker</span>] Successfully started [<span class="type">nginx</span>-<span class="type">proxy</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0119</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Checking <span class="keyword">if</span> container [<span class="type">service</span>-<span class="type">sidekick</span>] is running on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Checking <span class="keyword">if</span> container [<span class="type">service</span>-<span class="type">sidekick</span>] is running on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Starting container [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">worker</span>] Successfully started [<span class="type">kubelet</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] Starting container [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">worker</span>] Successfully started [<span class="type">kubelet</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0120</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0124</span>] [<span class="type">healthcheck</span>] service [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>] is healthy</span><br><span class="line">INFO[<span class="number">0124</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0124</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] Starting container [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">worker</span>] Successfully started [<span class="type">kube</span>-<span class="type">proxy</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">healthcheck</span>] service [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>] is healthy</span><br><span class="line">INFO[<span class="number">0125</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">healthcheck</span>] service [<span class="type">kubelet</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>] is healthy</span><br><span class="line">INFO[<span class="number">0125</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0125</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0125</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] Starting container [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">worker</span>] Successfully started [<span class="type">kube</span>-<span class="type">proxy</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] Image [<span class="type">rancher</span>/<span class="type">hyperkube</span>:<span class="type">v1.21.9</span>-<span class="type">rancher1</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] Starting container [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">worker</span>] Successfully started [<span class="type">kube</span>-<span class="type">proxy</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0126</span>] [<span class="type">healthcheck</span>] <span class="built_in">Start</span> Healthcheck on service [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0130</span>] [<span class="type">healthcheck</span>] service [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>] is healthy</span><br><span class="line">INFO[<span class="number">0130</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0130</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0130</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0130</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0130</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">healthcheck</span>] service [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>] is healthy</span><br><span class="line">INFO[<span class="number">0131</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">healthcheck</span>] service [<span class="type">kube</span>-<span class="type">proxy</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>] is healthy</span><br><span class="line">INFO[<span class="number">0131</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0131</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">worker</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">linker</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] [<span class="type">worker</span>] Successfully started Worker Plane..</span><br><span class="line">INFO[<span class="number">0131</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0131</span>] Image [<span class="type">rancher</span>/<span class="type">rke</span>-<span class="type">tools</span>:<span class="type">v0.1.78</span>] exists on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0132</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0132</span>] Starting container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">cleanup</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] on host [<span class="number">192.168</span><span class="type">.10.14</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">cleanup</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] on host [<span class="number">192.168</span><span class="type">.10.12</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">cleanup</span>] Successfully started [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] Removing container [<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] on host [<span class="number">192.168</span><span class="type">.10.10</span>], <span class="keyword">try</span> <span class="comment">#1</span></span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.14</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.12</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">remove</span>/<span class="type">rke</span>-<span class="type">log</span>-<span class="type">cleaner</span>] Successfully removed container on host [<span class="number">192.168</span><span class="type">.10.10</span>]</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">sync</span>] Syncing nodes Labels and Taints</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">sync</span>] Successfully synced nodes Labels and Taints</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">network</span>] Setting up network plugin: canal</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">addons</span>] Saving ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-network-plugin</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">addons</span>] Successfully saved ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-network-plugin</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0132</span>] [<span class="type">addons</span>] Executing deploy job rke<span class="literal">-network-plugin</span></span><br><span class="line">INFO[<span class="number">0137</span>] [<span class="type">addons</span>] Setting up coredns</span><br><span class="line">INFO[<span class="number">0137</span>] [<span class="type">addons</span>] Saving ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-coredns-addon</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0137</span>] [<span class="type">addons</span>] Successfully saved ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-coredns-addon</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0137</span>] [<span class="type">addons</span>] Executing deploy job rke<span class="literal">-coredns-addon</span></span><br><span class="line">INFO[<span class="number">0142</span>] [<span class="type">addons</span>] CoreDNS deployed successfully</span><br><span class="line">INFO[<span class="number">0142</span>] [<span class="type">dns</span>] DNS provider coredns deployed successfully</span><br><span class="line">INFO[<span class="number">0142</span>] [<span class="type">addons</span>] Setting up Metrics Server</span><br><span class="line">INFO[<span class="number">0142</span>] [<span class="type">addons</span>] Saving ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-metrics-addon</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0142</span>] [<span class="type">addons</span>] Successfully saved ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-metrics-addon</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0142</span>] [<span class="type">addons</span>] Executing deploy job rke<span class="literal">-metrics-addon</span></span><br><span class="line">INFO[<span class="number">0147</span>] [<span class="type">addons</span>] Metrics Server deployed successfully</span><br><span class="line">INFO[<span class="number">0147</span>] [<span class="type">ingress</span>] Setting up nginx ingress controller</span><br><span class="line">INFO[<span class="number">0147</span>] [<span class="type">ingress</span>] removing admission batch jobs <span class="keyword">if</span> they exist</span><br><span class="line">INFO[<span class="number">0147</span>] [<span class="type">addons</span>] Saving ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-ingress-controller</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0147</span>] [<span class="type">addons</span>] Successfully saved ConfigMap <span class="keyword">for</span> addon rke<span class="literal">-ingress-controller</span> to Kubernetes</span><br><span class="line">INFO[<span class="number">0147</span>] [<span class="type">addons</span>] Executing deploy job rke<span class="literal">-ingress-controller</span></span><br><span class="line">INFO[<span class="number">0152</span>] [<span class="type">ingress</span>] removing default backend service and deployment <span class="keyword">if</span> they exist</span><br><span class="line">INFO[<span class="number">0152</span>] [<span class="type">ingress</span>] ingress controller nginx deployed successfully</span><br><span class="line">INFO[<span class="number">0152</span>] [<span class="type">addons</span>] Setting up user addons</span><br><span class="line">INFO[<span class="number">0152</span>] [<span class="type">addons</span>] no user addons defined</span><br><span class="line">INFO[<span class="number">0152</span>] Finished building Kubernetes cluster successfully</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果部署失败，报错：</p>
<p>WARN[0114] [etcd] host [xxxxxxx] failed to check etcd health: failed
to get /health for host [xxxxxxx]: Get "https://xxxxxxxx:2379/health":
remote error: tls: bad certificate FATA[0114] [etcd] Failed to bring up
Etcd Plane: etcd cluster is unhealthy: hosts [xxxxxxxx] failed to report
healthy. Check etcd container logs on each host for more information</p>
<p>所有节点执行（无法删除就重启机器）：rm -rf /etc/kubernetes/
/var/lib/kubelet/ /var/lib/etcd/</p>
</blockquote>
<h2 id="九安装kubectl客户端">九、安装kubectl客户端</h2>
<blockquote>
<p>在master01主机上操作。</p>
</blockquote>
<h3 id="kubectl客户端安装">9.1 kubectl客户端安装</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget https://storage.googleapis.com/kubernetes-release/release/v1.21.9/bin/linux/amd64/kubectl</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chmod +x kubectl </span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mv kubectl /usr/local/bin/kubectl</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl version --client</span></span><br><span class="line">Client Version: version.Info&#123;Major:<span class="string">&quot;1&quot;</span>, Minor:<span class="string">&quot;21&quot;</span>, GitVersion:<span class="string">&quot;v1.21.9&quot;</span>, GitCommit:<span class="string">&quot;f59f5c2fda36e4036b49ec027e556a15456108f0&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>, BuildDate:<span class="string">&quot;2022-01-19T17:33:06Z&quot;</span>, GoVersion:<span class="string">&quot;go1.16.12&quot;</span>, Compiler:<span class="string">&quot;gc&quot;</span>, Platform:<span class="string">&quot;linux/amd64&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="kubectl客户端配置集群管理文件及应用验证">9.2
kubectl客户端配置集群管理文件及应用验证</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># ls /app/rancher/</span></span><br><span class="line">cluster.rkestate  cluster.yml  kube_config_cluster.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># mkdir ./.kube</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># cp /app/rancher/kube_config_cluster.yml /root/.kube/config</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES          AGE     VERSION</span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.10</span>   Ready    controlplane   <span class="number">9</span>m13s   v1.<span class="number">21.9</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.12</span>   Ready    worker         <span class="number">9</span>m12s   v1.<span class="number">21.9</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">10.14</span>   Ready    etcd           <span class="number">9</span>m12s   v1.<span class="number">21.9</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                                         READY   STATUS      RESTARTS   AGE</span><br><span class="line">calico<span class="literal">-kube-controllers-5685fbd9f7-gcwj7</span>     <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          <span class="number">9</span>m36s</span><br><span class="line">canal<span class="literal">-fz2bg</span>                                  <span class="number">2</span>/<span class="number">2</span>     Running     <span class="number">0</span>          <span class="number">9</span>m36s</span><br><span class="line">canal<span class="literal">-qzw4n</span>                                  <span class="number">2</span>/<span class="number">2</span>     Running     <span class="number">0</span>          <span class="number">9</span>m36s</span><br><span class="line">canal<span class="literal">-sstjn</span>                                  <span class="number">2</span>/<span class="number">2</span>     Running     <span class="number">0</span>          <span class="number">9</span>m36s</span><br><span class="line">coredns<span class="literal">-8578b6dbdd-ftnf6</span>                     <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          <span class="number">9</span>m30s</span><br><span class="line">coredns<span class="literal">-autoscaler-f7b68ccb7-fzdgc</span>           <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          <span class="number">9</span>m30s</span><br><span class="line">metrics<span class="literal">-server-6bc7854fb5-kwppz</span>              <span class="number">1</span>/<span class="number">1</span>     Running     <span class="number">0</span>          <span class="number">9</span>m25s</span><br><span class="line">rke<span class="literal">-coredns-addon-deploy-job--1-x56w2</span>        <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">9</span>m31s</span><br><span class="line">rke<span class="literal">-ingress-controller-deploy-job--1-wzp2b</span>   <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">9</span>m21s</span><br><span class="line">rke<span class="literal">-metrics-addon-deploy-job--1-ltlgn</span>        <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">9</span>m26s</span><br><span class="line">rke<span class="literal">-network-plugin-deploy-job--1-nsbfn</span>       <span class="number">0</span>/<span class="number">1</span>     Completed   <span class="number">0</span>          <span class="number">9</span>m41s</span><br></pre></td></tr></table></figure>
<h2 id="十集群web管理-rancher">十、集群web管理 rancher</h2>
<blockquote>
<p>在master01运行</p>
</blockquote>
<p>rancher控制面板主要方便用于控制k8s集群，查看集群状态，编辑集群等。</p>
<h3 id="使用docker-run启动一个rancher">10.1，使用docker
run启动一个rancher</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意映射端口改了</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># docker run -d --restart=unless-stopped --privileged --name rancher -p 1080:80 -p 1443:443 rancher/rancher:v2.5.9</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                                COMMAND                  CREATED          STATUS          PORTS                                                                      NAMES</span><br><span class="line"><span class="number">0</span>fd46ee77655   rancher/rancher:v2.<span class="number">5.9</span>               <span class="string">&quot;entrypoint.sh&quot;</span>          <span class="number">5</span> seconds ago    Up <span class="number">3</span> seconds    <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp, :::<span class="number">80</span>-&gt;<span class="number">80</span>/tcp, <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">443</span>-&gt;<span class="number">443</span>/tcp, :::<span class="number">443</span>-&gt;<span class="number">443</span>/tcp   rancher</span><br></pre></td></tr></table></figure>
<h3 id="访问rancher这里映射端口10801443">10.2
访问rancher【这里映射端口1080，1443】</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># ss -anput | grep &quot;:1080&quot;</span></span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>       *:<span class="number">1080</span>                    *:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">29564</span>,fd=<span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     <span class="number">0</span>      <span class="number">128</span>    [::]:<span class="number">1080</span>                 [::]:*                   users:((<span class="string">&quot;docker-proxy&quot;</span>,pid=<span class="number">29570</span>,fd=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222120525765.png" alt="image-20220222120525765">
<figcaption aria-hidden="true">image-20220222120525765</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222120615706.png" alt="image-20220222120615706">
<figcaption aria-hidden="true">image-20220222120615706</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222120657384.png" alt="image-20220222120657384">
<figcaption aria-hidden="true">image-20220222120657384</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222121036160.png" alt="image-20220222121036160">
<figcaption aria-hidden="true">image-20220222121036160</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222121132181.png" alt="image-20220222121132181">
<figcaption aria-hidden="true">image-20220222121132181</figcaption>
</figure>
<h3 id="在rancher-web界面添加kubernetes集群">10.3 在rancher
web界面添加kubernetes集群</h3>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222121419801.png" alt="image-20220222121419801">
<figcaption aria-hidden="true">image-20220222121419801</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222121500369.png" alt="image-20220222121500369">
<figcaption aria-hidden="true">image-20220222121500369</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222121639207.png" alt="image-20220222121639207">
<figcaption aria-hidden="true">image-20220222121639207</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222121800708.png" alt="image-20220222121800708">
<figcaption aria-hidden="true">image-20220222121800708</figcaption>
</figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用第一条报错：</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># kubectl apply -f https://192.168.10.10/v3/import/vljtg5srnznpzts662q6ncs4jm6f8kd847xqs97d6fbs5rhn7kfzvk_c-ktwhn.yaml</span></span><br><span class="line">Unable to connect to the server: x509: certificate is valid <span class="keyword">for</span> <span class="number">127.0</span>.<span class="number">0.1</span>, <span class="number">172.17</span>.<span class="number">0.2</span>, not <span class="number">192.168</span>.<span class="number">10.10</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">使用第二条：</span><br><span class="line"></span><br><span class="line">第一次报错：</span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl --insecure -sfL https://192.168.10.10/v3/import/vljtg5srnznpzts662q6ncs4jm6f8kd847xqs97d6fbs5rhn7kfzvk_c-ktwhn.yaml | kubectl apply -f -</span></span><br><span class="line">error: no objects passed to apply</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第二次成功：</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">master01</span> ~]<span class="comment"># curl --insecure -sfL https://192.168.10.10/v3/import/vljtg5srnznpzts662q6ncs4jm6f8kd847xqs97d6fbs5rhn7kfzvk_c-ktwhn.yaml | kubectl apply -f -</span></span><br><span class="line">Warning: resource clusterroles/proxy<span class="literal">-clusterrole-kubeapiserver</span> is missing the kubectl.kubernetes.io/last<span class="literal">-applied-configuration</span> annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create <span class="literal">--save-config</span> or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/proxy<span class="literal">-clusterrole-kubeapiserver</span> configured</span><br><span class="line">Warning: resource clusterrolebindings/proxy<span class="literal">-role-binding-kubernetes-master</span> is missing the kubectl.kubernetes.io/last<span class="literal">-applied-configuration</span> annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create <span class="literal">--save-config</span> or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/proxy<span class="literal">-role-binding-kubernetes-master</span> configured</span><br><span class="line">namespace/cattle<span class="literal">-system</span> created</span><br><span class="line">serviceaccount/cattle created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/cattle<span class="literal">-admin-binding</span> created</span><br><span class="line">secret/cattle<span class="literal">-credentials-0619853</span> created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/cattle<span class="literal">-admin</span> created</span><br><span class="line">Warning: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[<span class="number">0</span>].matchExpressions[<span class="number">0</span>].key: beta.kubernetes.io/os is deprecated since v1.<span class="number">14</span>; use <span class="string">&quot;kubernetes.io/os&quot;</span> instead</span><br><span class="line">deployment.apps/cattle<span class="literal">-cluster-agent</span> created</span><br></pre></td></tr></table></figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222124826542.png" alt="image-20220222124826542">
<figcaption aria-hidden="true">image-20220222124826542</figcaption>
</figure>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/k8s%E9%83%A8%E7%BD%B2nebulaGraph//image-20220222124844668.png" alt="image-20220222124844668">
<figcaption aria-hidden="true">image-20220222124844668</figcaption>
</figure>
<ul>
<li><p>查看pod运行在那个节点</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看podid</span></span><br><span class="line">kubectl get pods <span class="literal">-o</span> wide</span><br><span class="line"><span class="comment">#进入pod</span></span><br><span class="line">kubectl exec <span class="literal">-it</span> containerid  <span class="literal">--</span> /bin/sh</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="十一搭建nfs服务器">十一，搭建nfs服务器</h2>
<ul>
<li><p>```powershell [root@nfsserver ~]# mkdir -p /data/nfs
[root@nfsserver ~]# vim /etc/exports /data/nfs *(rw,no_root_squash,sync)
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 所有节点中安装nfs客户端</span><br><span class="line"></span><br><span class="line">  ```powershell</span><br><span class="line">  yum install nfs-utils -y</span><br></pre></td></tr></table></figure></p></li>
<li><p>验证是否可用再工作节点中</p></li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount <span class="literal">-e</span> <span class="number">192.168</span>.<span class="number">222.143</span> <span class="comment">#nfs服务器的地址</span></span><br></pre></td></tr></table></figure>
<h2 id="十二-使用nfs文件系统创建存储动态供给storageclass安装">十二
使用NFS文件系统创建存储动态供给(storageclass安装)</h2>
<p>PV对存储系统的支持可通过其插件来实现，目前，Kubernetes支持如下类型的插件。</p>
<p>PV对存储系统的支持可通过其插件来实现，目前，Kubernetes支持如下类型的插件。</p>
<p>官方地址：https://kubernetes.io/docs/concepts/storage/storage-classes/</p>
<p>官方插件是不支持NFS动态供给的，但是我们可以用第三方的插件来实现</p>
<p>第三方插件地址:
https://github.com/kubernetes-retired/external-storage</p>
<h3 id="下载并创建storageclass">12.1，下载并创建storageclass</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># wget https://raw.githubusercontent.com/kubernetes-sigs/nfs-subdir-external-provisioner/master/deploy/class.yaml</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># mv class.yaml storageclass-nfs.yml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># cat storageclass-nfs.yml</span></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass				<span class="comment"># 类型</span></span><br><span class="line">metadata:</span><br><span class="line">  name: nfs<span class="literal">-client</span>		<span class="comment"># 名称,要使用就需要调用此名称</span></span><br><span class="line">provisioner: k8s<span class="literal">-sigs</span>.io/nfs<span class="literal">-subdir-external-provisioner</span> 	<span class="comment"># 动态供给插件</span></span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: <span class="string">&quot;false&quot;</span>		<span class="comment"># 删除数据时是否存档，false表示不存档，true表示存档</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># kubectl apply -f storageclass-nfs.yml</span></span><br><span class="line">storageclass.storage.k8s.io/managed<span class="literal">-nfs-storage</span> created</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># kubectl get storageclass</span></span><br><span class="line">NAME         PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs<span class="literal">-client</span>   k8s<span class="literal">-sigs</span>.io/nfs<span class="literal">-subdir-external-provisioner</span>   Delete          Immediate           false                  <span class="number">10</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># RECLAIMPOLICY pv回收策略，pod或pvc被删除后，pv是否删除还是保留。</span></span><br><span class="line"><span class="comment"># VOLUMEBINDINGMODE Immediate 模式下PVC与PV立即绑定，主要是不等待相关Pod调度完成，不关心其运行节点，直接完成绑定。相反的 WaitForFirstConsumer模式下需要等待Pod调度完成后进行PV绑定。</span></span><br><span class="line"><span class="comment"># ALLOWVOLUMEEXPANSION pvc扩容</span></span><br></pre></td></tr></table></figure>
<h3 id="下载并创建rbac">12.2，下载并创建rbac</h3>
<p>因为storage自动创建pv需要经过kube-apiserver，所以需要授权。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># wget https://raw.githubusercontent.com/kubernetes-sigs/nfs-subdir-external-provisioner/master/deploy/rbac.yaml</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># mv rbac.yaml storageclass-nfs-rbac.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># cat storageclass-nfs-rbac.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  namespace: default</span><br><span class="line"><span class="literal">---</span></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs<span class="literal">-client-provisioner-runner</span></span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="literal">---</span></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: run<span class="literal">-nfs-client-provisioner</span></span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs<span class="literal">-client-provisioner-runner</span></span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"><span class="literal">---</span></span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: leader<span class="literal">-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    resources: [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="literal">---</span></span><br><span class="line">kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: leader<span class="literal">-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  namespace: default</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role</span><br><span class="line">  name: leader<span class="literal">-locking-nfs-client-provisioner</span></span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># kubectl apply -f rbac.yaml</span></span><br><span class="line">serviceaccount/nfs<span class="literal">-client-provisioner</span> created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs<span class="literal">-client-provisioner-runner</span> created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run<span class="literal">-nfs-client-provisioner</span> created</span><br><span class="line">role.rbac.authorization.k8s.io/leader<span class="literal">-locking-nfs-client-provisioner</span> created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/leader<span class="literal">-locking-nfs-client-provisioner</span> created</span><br></pre></td></tr></table></figure>
<h3 id="创建动态供给的deployment">12.3，创建动态供给的deployment</h3>
<p>需要一个deployment来专门实现pv与pvc的自动创建</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># vim deploy-nfs-client-provisioner.yml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: <span class="number">1</span></span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">    spec:</span><br><span class="line">      serviceAccount: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs<span class="literal">-client-provisioner</span></span><br><span class="line">          image: registry.cn<span class="literal">-beijing</span>.aliyuncs.com/pylixm/nfs<span class="literal">-subdir-external-provisioner</span>:v4.<span class="number">0.0</span></span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs<span class="literal">-client-root</span></span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: k8s<span class="literal">-sigs</span>.io/nfs<span class="literal">-subdir-external-provisioner</span></span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: <span class="number">192.168</span>.<span class="number">10.129</span></span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /<span class="keyword">data</span>/nfs</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs<span class="literal">-client-root</span></span><br><span class="line">          nfs:</span><br><span class="line">            server: <span class="number">192.168</span>.<span class="number">10.129</span></span><br><span class="line">            path: /<span class="keyword">data</span>/nfs</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># kubectl apply -f deploy-nfs-client-provisioner.yml</span></span><br><span class="line">deployment.apps/nfs<span class="literal">-client-provisioner</span> created</span><br></pre></td></tr></table></figure>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">k8s</span>-<span class="type">master1</span> ~]<span class="comment"># kubectl get pods |grep nfs-client-provisioner</span></span><br><span class="line">nfs<span class="literal">-client-provisioner-5b5ddcd6c8-b6zbq</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">34</span>s</span><br></pre></td></tr></table></figure>
<h2 id="十三nebulagraph-operator-安装部署">十三，nebulaGraph operator
安装部署</h2>
<ul>
<li><p>参考官网 安装 NebulaGraph Operator
前，用户需要安装以下软件并确保安装版本的正确性（NebulaGraph Operator
不负责处理安装这些软件过程中出现的问题）。</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">软件</th>
<th style="text-align: left;">版本要求</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><a target="_blank" rel="noopener" href="https://kubernetes.io/">Kubernetes</a></td>
<td style="text-align: left;">&gt;= 1.16</td>
</tr>
<tr class="even">
<td style="text-align: left;"><a target="_blank" rel="noopener" href="https://helm.sh/">Helm</a></td>
<td style="text-align: left;">&gt;= 3.2.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><a target="_blank" rel="noopener" href="https://github.com/coredns/coredns">CoreDNS</a></td>
<td style="text-align: left;">&gt;= 1.6.0</td>
</tr>
</tbody>
</table></li>
<li><p>Helm安装</p>
<p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">a</span> ~]<span class="comment"># curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line"><span class="number">100</span> <span class="number">11345</span>  <span class="number">100</span> <span class="number">11345</span>    <span class="number">0</span>     <span class="number">0</span>  <span class="number">18830</span>      <span class="number">0</span> <span class="literal">--</span>:<span class="literal">--</span>:<span class="literal">--</span> <span class="literal">--</span>:<span class="literal">--</span>:<span class="literal">--</span> <span class="literal">--</span>:<span class="literal">--</span>:<span class="literal">--</span> <span class="number">18845</span></span><br><span class="line">[<span class="type">WARNING</span>] Could not find git. It is required <span class="keyword">for</span> plugin installation.</span><br><span class="line">Downloading https://get.helm.sh/helm<span class="literal">-v3</span>.<span class="number">12.1</span><span class="literal">-linux-amd64</span>.tar.gz</span><br><span class="line">Verifying checksum... Done.</span><br><span class="line">Preparing to install helm into /usr/local/bin</span><br><span class="line">helm installed into /usr/local/bin/helm</span><br></pre></td></tr></table></figure></p></li>
<li><p>coreDNS安装可以网上查阅资料(上面rke安装过程中已经安装了coredns)</p></li>
<li><p>安装 NebulaGraph Operator</p></li>
</ul>
<ol type="1">
<li><p>添加 NebulaGraph Operator Helm 仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add nebula-operator https://vesoft-inc.github.io/nebula-operator/charts</span><br></pre></td></tr></table></figure></li>
<li><p>拉取最新的 Operator Helm 仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<p>参考 <a target="_blank" rel="noopener" href="https://helm.sh/docs/helm/helm_repo/">Helm
仓库</a>获取更多<code>helm repo</code>相关信息。</p></li>
<li><p>创建命名空间用于安装 NebulaGraph Operator。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace &lt;namespace_name&gt;</span><br></pre></td></tr></table></figure>
<p>例如，创建operator命名空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace operator</span><br></pre></td></tr></table></figure>
<ul>
<li>nebula-operator chart 中的所有资源都会安装在该命名空间下。</li>
<li>用户也可创建其他命名空间。</li>
</ul></li>
<li><p>安装 NebulaGraph Operator。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install nebula-operator nebula-operator/nebula-operator --namespace=&lt;namespace_name&gt; --version=$&#123;chart_version&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 目前1.5.0无法安装 可以不指定版本 默认安装最新版本,由于gcr.io无法下载镜像使用kubesphere/kube-rbac-proxy:v0.8.0代替</span><br><span class="line"></span><br><span class="line">helm install nebula-operator nebula-operator/nebula-operator --namespace=nebula-operator-system --set image.kubeRBACProxy.image=kubesphere/kube-rbac-proxy:v0.8.0</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><h3 id="卸载-nebulagraph-operator">卸载 NebulaGraph Operator</h3>
<ol type="1">
<li><p>卸载 NebulaGraph Operator chart。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm uninstall nebula-operator --namespace=operator</span><br></pre></td></tr></table></figure></li>
<li><p>删除 CRD。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete crd nebulaclusters.apps.nebula-graph.io</span><br></pre></td></tr></table></figure></li>
</ol></li>
</ul>
<h2 id="十四部署nebulagraphkubectl">十四，部署nebulaGraph（kubectl）</h2>
<ul>
<li>创建集群配置文件。</li>
</ul>
<p>​
创建名为<code>apps_v1alpha1_nebulacluster.yaml</code>的文件。官网提供了模板可以直接下载</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps.nebula<span class="literal">-graph</span>.io/v1alpha1</span><br><span class="line">kind: NebulaCluster</span><br><span class="line">metadata:</span><br><span class="line">  name: nebula</span><br><span class="line">spec:</span><br><span class="line">  graphd:</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: <span class="string">&quot;500m&quot;</span></span><br><span class="line">        memory: <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">      limits:</span><br><span class="line">        cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">        memory: <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">    replicas: <span class="number">1</span></span><br><span class="line">    image: vesoft/nebula<span class="literal">-graphd</span></span><br><span class="line">    version: v3.<span class="number">5.0</span></span><br><span class="line">    service:</span><br><span class="line">      <span class="built_in">type</span>: NodePort</span><br><span class="line">      externalTrafficPolicy: Local</span><br><span class="line">    logVolumeClaim:</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: <span class="number">1</span><span class="built_in">Gi</span></span><br><span class="line">      storageClassName: managed<span class="literal">-nfs-storage</span></span><br><span class="line">  metad:</span><br><span class="line"><span class="comment">#    license:</span></span><br><span class="line"><span class="comment">#      secretName: &quot;nebula-license&quot;</span></span><br><span class="line"><span class="comment">#      licenseKey: &quot;nebula.license&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: <span class="string">&quot;500m&quot;</span></span><br><span class="line">        memory: <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">      limits:</span><br><span class="line">        cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">        memory: <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">    replicas: <span class="number">1</span></span><br><span class="line">    image: vesoft/nebula<span class="literal">-metad</span></span><br><span class="line">    version: v3.<span class="number">5.0</span></span><br><span class="line">    dataVolumeClaim:</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: <span class="number">5</span><span class="built_in">Gi</span></span><br><span class="line">      storageClassName:  managed<span class="literal">-nfs-storage</span></span><br><span class="line">    logVolumeClaim:</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: <span class="number">1</span><span class="built_in">Gi</span></span><br><span class="line">      storageClassName:  managed<span class="literal">-nfs-storage</span></span><br><span class="line">  storaged:</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        cpu: <span class="string">&quot;500m&quot;</span></span><br><span class="line">        memory: <span class="string">&quot;500Mi&quot;</span></span><br><span class="line">      limits:</span><br><span class="line">        cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：所有的storageClassName需要和上面安装storageclass时名称相同。 即
storageclass-nfs.yml中的 metadata.name: nfs-client</p>
</blockquote>
<ul>
<li><p>查看状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nebula-exporter-66457984-w6zpn            1/1     Running   0          31m</span><br><span class="line">nebula-graphd-0                           2/2     Running   0          31m</span><br><span class="line">nebula-metad-0                            2/2     Running   0          35m</span><br><span class="line">nebula-storaged-0                         2/2     Running   0          35m</span><br><span class="line">nebula-storaged-1                         0/2     Pending   0          35m</span><br><span class="line">nebula-storaged-2                         0/2     Pending   0          35m</span><br><span class="line">nfs-client-provisioner-6bd7f48698-m4v94   1/1     Running   0          57m</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="十五连接nebula">十五，连接nebula</h2>
<ul>
<li><p>按照官网提供的模板修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    # modify the cluster name</span><br><span class="line">    app.kubernetes.io/cluster: &quot;nebula&quot;</span><br><span class="line">    app.kubernetes.io/component: graphd</span><br><span class="line">    app.kubernetes.io/managed-by: nebula-operator</span><br><span class="line">    app.kubernetes.io/name: nebula-graph</span><br><span class="line">  name: nebula-graphd-nodeport-svc</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  externalTrafficPolicy: Cluster #改为local，无法连接到数据库，这里改为Cluster</span><br><span class="line">  ports:</span><br><span class="line">  - name: thrift</span><br><span class="line">    port: 9669</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9669</span><br><span class="line">  - name: http</span><br><span class="line">    port: 19669</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 19669</span><br><span class="line">  selector:</span><br><span class="line">    # modify the cluster name</span><br><span class="line">    app.kubernetes.io/cluster: &quot;nebula&quot;</span><br><span class="line">    app.kubernetes.io/component: graphd</span><br><span class="line">    app.kubernetes.io/managed-by: nebula-operator</span><br><span class="line">    app.kubernetes.io/name: nebula-graph</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure></li>
<li><p>执行以下命令使 Service 服务在集群中生效。</p></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f graphd-nodeport-service.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 Service 中NebulaGraph映射至集群节点的端口。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get services -l app.kubernetes.io/cluster=&lt;nebula&gt;  #&lt;nebula&gt;为变量值，请用实际集群名称替换。</span><br></pre></td></tr></table></figure>
<ul>
<li>返回：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                                          AGE</span><br><span class="line">nebula-graphd-svc-nodeport     NodePort    10.107.153.129 &lt;none&gt;        9669:32236/TCP,19669:31674/TCP,19670:31057/TCP   24h</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>NodePort</code>类型的 Service
中，映射至集群节点的端口为<code>32236</code>。</p>
<ol type="1">
<li><p>使用节点 IP 和上述映射的节点端口连接 NebulaGraph。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -ti --image vesoft/nebula-console:v3.5.0 --restart=Never -- &lt;nebula_console_name&gt; -addr &lt;node_ip&gt; -port &lt;node_port&gt; -u &lt;username&gt; -p &lt;password&gt;</span><br></pre></td></tr></table></figure>
<p>示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -ti --image vesoft/nebula-console:v3.5.0 --restart=Never -- nebula-console -addr 192.168.8.24 -port 32236 -u root -p vesoft</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line"></span><br><span class="line">(root@nebula) [(none)]&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--image</code>：为连接NebulaGraph的工具 NebulaGraph Console
的镜像。</li>
<li><code>&lt;nebula-console&gt;</code>：自定义的 Pod
名称。本示例为<code>nebula-console</code>。</li>
<li><code>-addr</code>：NebulaGraph集群中任一节点 IP
地址。本示例为<code>192.168.8.24</code>。</li>
<li><code>-port</code>：NebulaGraph映射至节点的端口。本示例为<code>32236</code>。</li>
<li><code>-u</code>：NebulaGraph账号的用户名。未启用身份认证时，可以使用任意已存在的用户名（默认为
root）。</li>
<li><code>-p</code>：用户名对应的密码。未启用身份认证时，密码可以填写任意字符。</li>
</ul></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2023-05-09T18:45:12.000Z" title="2023/5/10 02:45:12">2023-05-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-06-22T07:27:52.708Z" title="2023/6/22 15:27:52">2023-06-22</time></span><span class="level-item"><a class="link-muted" href="">数据库</a></span><span class="level-item">13 minutes read (About 1995 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="../../2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93nebulaGraph%E9%80%89%E5%9E%8B/">图数据库nebulaGraph选型</a></p><div class="content"><h1 id="nebulagraph-选型">nebulaGraph 选型</h1>
<h2 id="一.why-nebulagraph">一.why nebulaGraph ？</h2>
<p>在图数据库的选型上我们主要考虑了以下 5 点：(A)
项目开源，暂不考虑需付费的图数据库；(B)
分布式架构设计，具备良好的可扩展性；© 毫秒级的多跳查询延迟；(D)
支持千亿量级点边存储；(E) 具备批量从数仓导入数据的能力。</p>
<p>分析 DB-Engines[2] 上排名前 30
的图数据库，剔除不开源的项目，我们将剩余的图数据库分为三类：</p>
<ul>
<li><strong>第一类：Neo4j[3]、ArangoDB[4]、Virtuoso[5]、TigerGraph[6]、RedisGraph[7]。</strong>
此类图数据库只有单机版本开源可用，性能优秀，但不能应对分布式场景中数据的规模增长，即不满足选型要求（B）、（D）。</li>
<li><strong>第二类：JanusGraph[8]、HugeGraph[9]。</strong>
此类图数据库在现有存储系统之上新增了通用的图语义解释层，图语义层提供了图遍历的能力，但是受到存储层或者架构限制，不支持完整的计算下推，多跳遍历的性能较差，很难满足
OLTP 场景下对低延时的要求，即不满足选型要求（C）。</li>
<li><strong>第三类：DGraph[10]、NebulaGraph[11]。</strong>
此类图数据库根据图数据的特点对数据存储模型、点边分布、执行引擎进行了全新设计，对图的多跳遍历进行了深度优化，基本满足我们的选型要求。</li>
</ul>
<p>DGraph 是由前 Google 员工 Manish Rai Jain 离职创业后，在 2016
年推出的图数据库产品，底层数据模型是 RDF[12]，基于 Go
语言编写，存储引擎基于 BadgerDB[13] 改造，使用 RAFT
保证数据读写的强一致性。</p>
<p>NebulaGraph 是由前 Facebook 员工叶小萌离职创业后，在 2019年
推出的图数据库产品，底层数据模型是属性图，基于 C++
语言编写，存储引擎基于 RocksDB[14] 改造，使用 RAFT
保证数据读写的强一致性。</p>
<p>这两个项目的创始人都在互联网公司图数据库领域深耕多年，对图数据库的落地痛点有深刻认识，整体的架构设计也有较多相似之处。在图数据库最终的选型上，我们基于
LDBC-SNB 数据集[15]对 NebulaGraph、DGraph、HugeGraph
进行了深度性能测评，测试详情见文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg4OTg0MzY0Mw==&amp;mid=2247492115&amp;idx=1&amp;sn=1fd71049c940f9ee0013782cf6733a14&amp;source=41#wechat_redirect">主流开源分布式图数据库
Benchmark</a>，从测试结果看 NebulaGraph
在数据导入、实时写入及多跳查询方面性能均优于竞品。此外，NebulaGraph
社区活跃，问题响应速度快，所以团队最终选择基于 NebulaGraph
来搭建图数据库平台</p>
<h2 id="二.nebulagraph架构">二.nebulagraph架构</h2>
<figure>
<img src="/2023/05/10/%E6%95%B0%E6%8D%AE%E5%BA%93/graphdatabase/%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93nebulaGraph%E9%80%89%E5%9E%8B//nebulaGraph架构.png" alt="nebulaGraph架构">
<figcaption aria-hidden="true">nebulaGraph架构</figcaption>
</figure>
<p>一个完整的 NebulaGraph 集群包含三类服务，即 Query Service、Storage
Service 和 Meta
Service。每类服务都有其各自的可执行二进制文件，既可以部署在同一节点上，也可以部署在不同的节点上。下面是NebulaGraph
架构设计（见图 3）的几个核心点[16][17]。</p>
<ul>
<li><strong>Meta Service：</strong> 架构图中右侧为 Meta Service
集群，它采用 Leader/Follower 架构。Leader 由集群中所有的 Meta Service
节点选出，然后对外提供服务；Followers 处于待命状态，并从 Leader
复制更新的数据。一旦 Leader 节点 Down 掉，会再选举其中一个 Follower
成为新的 Leader。Meta Service 不仅负责存储和提供图数据的 Meta 信息，如
Schema、数据分片信息等；同时还提供 Job Manager
机制管理长耗时任务，负责指挥数据迁移、Leader 变更、数据
compaction、索引重建等运维操作。</li>
<li><strong>存储计算分离：</strong> 在架构图中 Meta Service 的左侧，为
NebulaGraph 的主要服务，NebulaGraph
采用存储与计算分离的架构，虚线以上为计算，以下为存储。存储计算分离有诸多优势，最直接的优势就是，计算层和存储层可以根据各自的情况弹性扩容、缩容。存储计算分离还带来了另一个优势：使水平扩展成为可能。此外，存储计算分离使得
Storage Service 可以为多种类型的计算层或者计算引擎提供服务。当前 Query
Service 是一个高优先级的 OLTP 计算层，而各种 OLAP
迭代计算框架会是另外一个计算层。</li>
<li><strong>无状态计算层：</strong>
每个计算节点都运行着一个无状态的查询计算引擎，而节点彼此间无任何通信关系。计算节点仅从
Meta Service 读取 Meta 信息以及和 Storage Service
进行交互。这样设计使得计算层集群更容易使用 K8s
管理或部署在云上。每个查询计算引擎都能接收客户端的请求，解析查询语句，生成抽象语法树（AST）并将
AST 传递给执行计划器和优化器，最后再交由执行器执行。</li>
<li><strong>Shared-nothing 分布式存储层：</strong> Storage Service 采用
Shared-nothing 的分布式架构设计，共有三层，最底层是 Store
Engine，它是一个单机版 Local Store
Engine，提供了对本地数据的get/put/scan/delete
操作，该层定义了数据操作接口，用户可以根据自己的需求定制开发相关 Local
Store Plugin。目前，NebulaGraph 提供了基于 RocksDB 实现的 Store
Engine。在 Local Store Engine 之上是 Consensus 层，实现了 Multi Group
Raft，每一个 Partition 都对应了一组 Raft Group。在 Consensus 层上面是
Storage interfaces，这一层定义了一系列和图相关的 API。 这些 API
请求会在这一层被翻译成一组针对相应 Partition 的 KV
操作。正是这一层的存在，使得存储服务变成了真正的图存储。否则，Storage
Service 只是一个 KV 存储罢了。而 NebulaGraph 没把 KV
作为一个服务单独提出，最主要的原因便是图查询过程中会涉及到大量计算，这些计算往往需要使用图的
Schema，而 KV 层没有数据 Schema 概念，这样设计比较容易实现计算下推，是
NebulaGraph 查询性能优越的主要原因。</li>
</ul>
<p>NebulaGraph 基于 C++
实现，架构设计支持存储千亿顶点、万亿边，并提供毫秒级别的查询延时。我们在
3 台 48U192G 物理机搭建的集群上灌入 10 亿美食图谱数据对 NebulaGraph
的功能进行了验证。</p>
<ul>
<li>一跳查询 TP99 延时在 5ms 内，两跳查询 TP99 延时在 20ms
内，一般的多跳查询 TP99 延时在百毫秒内。</li>
<li>集群在线写入速率约为20万 Records/s。</li>
<li>支持通过 Spark 任务离线生成 RocksDB 底层 SST
File，直接将数据文件载入到集群中，即类似 HBase BulkLoad 能力。</li>
<li>提供了类 SQL 查询语言，对于新增的业务需求，只需构造 NebulaGraph SQL
语句，易于理解且能满足各类复杂查询要求。</li>
<li>提供联合索引、GEO
索引，可通过实体属性或者关系属性查询实体、关系，或者查询在某个经纬度附近
N 米内的实体。</li>
<li>一个 NebulaGraph 集群中可以创建多个 Space （概念类似 MySQL
的DataBase），并且不同 Space 中的数据在物理上是隔离的。</li>
</ul>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="../../img/avatar.png" alt="albert"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">albert</p><p class="is-size-6 is-block">albert</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>shanghai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="../../archives"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="../../categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="../../tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/0914ds" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="../../index.html"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="../JVM%E8%B0%83%E4%BC%98%E5%90%88%E9%9B%86/"><span class="level-start"><span class="level-item">JVM调优合集</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="../%E5%AE%B9%E5%99%A8/"><span class="level-start"><span class="level-item">容器</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href=""><span class="level-start"><span class="level-item">数据库</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">机器学习</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="../%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="level-start"><span class="level-item">消息中间件</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-17T17:13:16.000Z">2023-08-18</time></p><p class="title"><a href="../../2023/08/18/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D/">多元线性回归</a></p><p class="categories"><a href="../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-17T05:13:16.000Z">2023-08-17</time></p><p class="title"><a href="../../2023/08/17/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%A4%9A%E5%85%83%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/">多元线性回归</a></p><p class="categories"><a href="../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-16T17:30:16.000Z">2023-08-17</time></p><p class="title"><a href="../../2023/08/17/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/3-%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E4%BC%98%E5%8C%96/">梯度下降优化</a></p><p class="categories"><a href="../%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-17T06:13:16.000Z">2023-06-17</time></p><p class="title"><a href="../../2023/06/17/%E6%B6%88%E6%81%AF/kafka/">kafka</a></p><p class="categories"><a href="../%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">消息中间件</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T07:02:29.235Z">2023-06-05</time></p><p class="title"><a href="../../2023/06/05/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql%E7%9A%84%E9%94%81%E6%9C%BA%E5%88%B6/">mysql的锁机制</a></p><p class="categories"><a href="">数据库</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="../../archives/2023/08/"><span class="level-start"><span class="level-item">August 2023</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="../../archives/2023/06/"><span class="level-start"><span class="level-item">June 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="../../archives/2023/05/"><span class="level-start"><span class="level-item">May 2023</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="../../archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="../../index.html"><img src="../../img/logo.svg" alt="blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 albert dong</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="../../js/column.js"></script><script src="../../js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="../../js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="../../js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="../../js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"../../content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>